<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi - UPTD SD Negeri 2 Tanjung Qencono</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes logoAnimation {
            0% { opacity: 0; transform: scale(0.8); }
            10% { opacity: 1; transform: scale(1); }
            25% { opacity: 1; transform: scale(1); }
            35% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 0; transform: scale(0.8); }
        }
        
        .logo-animate {
            animation: logoAnimation 9s infinite;
            opacity: 0;
        }
        
        .logo-animate:nth-child(1) {
            animation-delay: 0s;
        }
        
        .logo-animate:nth-child(2) {
            animation-delay: 3s;
        }
        
        .logo-animate:nth-child(3) {
            animation-delay: 6s;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-scroll {
            animation: scroll 20s linear infinite;
        }
        
        @keyframes scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-33.333%); }
        }
    </style>
</head>
<body class="bg-gray-200 min-h-screen pb-20">
    <!-- Header dengan Logo Animasi -->
    <div class="bg-blue-800 shadow-lg border-b-4 border-yellow-400">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-center space-x-4">
                <div class="relative w-16 h-16">
                    <img src="https://iili.io/FSNupqu.png" alt="Logo 1" class="absolute inset-0 w-full h-full object-contain logo-animate">
                    <img src="https://iili.io/FgOpdgt.png" alt="Logo 2" class="absolute inset-0 w-full h-full object-contain logo-animate">
                    <img src="https://iili.io/Fge9uDb.png" alt="Logo 3" class="absolute inset-0 w-full h-full object-contain logo-animate">
                </div>
                <div class="text-center">
                    <h1 class="text-2xl font-bold text-white">UPTD SD NEGERI 2 TANJUNG QENCONO</h1>
                    <p class="text-yellow-300">Sistem Absensi Siswa</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="container mx-auto px-4 py-8">
        <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-6 border-2 border-blue-200">
            <h2 class="text-2xl font-bold text-center mb-6 text-blue-800">Login Sistem</h2>
            
            <div class="space-y-4 mb-6">
                <button onclick="showLoginForm('admin')" class="w-full bg-blue-700 hover:bg-blue-800 text-white py-3 px-4 rounded-lg font-medium transition duration-200 border-2 border-yellow-400">
                    Login Operator Sekolah
                </button>
                <button onclick="showLoginForm('guru')" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-medium transition duration-200 border-2 border-yellow-300">
                    Login Guru
                </button>
                <button onclick="guestLogin()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-blue-800 py-3 px-4 rounded-lg font-medium transition duration-200 border-2 border-blue-300">
                    Akses Pengunjung
                </button>
            </div>

            <!-- Form Login -->
            <div id="loginForm" class="hidden">
                <div class="space-y-4">
                    <div>
                        <label class="block text-blue-800 font-medium mb-2">Username</label>
                        <input type="text" id="username" class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400">
                    </div>
                    <div>
                        <label class="block text-blue-800 font-medium mb-2">Password</label>
                        <div class="relative">
                            <input type="password" id="password" class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 pr-10">
                            <button type="button" onclick="togglePassword()" class="absolute right-3 top-2.5 text-blue-600 hover:text-blue-800">
                                <span id="eyeIcon">üëÅÔ∏è</span>
                            </button>
                        </div>
                    </div>
                    <button onclick="login()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-blue-800 py-2 px-4 rounded-lg font-medium transition duration-200 border-2 border-blue-300">
                        Masuk
                    </button>
                    <button onclick="hideLoginForm()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-medium transition duration-200 border-2 border-yellow-300">
                        Batal
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Admin -->
    <div id="adminDashboard" class="hidden container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6 border-2 border-blue-200">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-blue-800">Dashboard Operator Sekolah</h2>
                    <p class="text-blue-600 text-sm mt-1">üìÖ <span id="adminDate"></span></p>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="showSettings()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg border-2 border-gray-400 flex items-center space-x-1" title="Pengaturan Sistem">
                        <span>‚öôÔ∏è</span>
                        <span class="hidden sm:inline">Pengaturan</span>
                    </button>
                    <button onclick="logout()" class="bg-blue-700 hover:bg-blue-800 text-white px-4 py-2 rounded-lg border-2 border-yellow-400">Logout</button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <button onclick="showAbsensiForm()" class="bg-blue-600 hover:bg-blue-700 text-white py-4 px-6 rounded-lg font-medium border-2 border-yellow-300">
                    Input Absensi
                </button>
                <button onclick="showDataAbsensi()" class="bg-yellow-500 hover:bg-yellow-600 text-blue-800 py-4 px-6 rounded-lg font-medium border-2 border-blue-300">
                    Lihat Data Absensi
                </button>
                <button onclick="showManageData()" class="bg-blue-700 hover:bg-blue-800 text-white py-4 px-6 rounded-lg font-medium border-2 border-yellow-400">
                    Kelola Data
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="showUserManagement()" class="bg-purple-600 hover:bg-purple-700 text-white py-3 px-4 rounded-lg font-medium border-2 border-purple-400">
                    üë• Kelola User
                </button>
                <button onclick="showSystemInfo()" class="bg-gray-600 hover:bg-gray-700 text-white py-3 px-4 rounded-lg font-medium border-2 border-gray-400">
                    ‚ÑπÔ∏è Info Sistem
                </button>
            </div>
        </div>
        
        <div id="adminContent"></div>
    </div>

    <!-- Dashboard Guru -->
    <div id="guruDashboard" class="hidden container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6 border-2 border-blue-200">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-blue-800">Dashboard Guru</h2>
                    <p class="text-blue-600 text-sm mt-1">üìÖ <span id="guruDate"></span></p>
                </div>
                <button onclick="logout()" class="bg-blue-700 hover:bg-blue-800 text-white px-4 py-2 rounded-lg border-2 border-yellow-400">Logout</button>
            </div>
            <p class="text-blue-600">Selamat datang, <span id="guruName"></span></p>
        </div>
        
        <div id="guruContent"></div>
    </div>

    <!-- Dashboard Pengunjung -->
    <div id="guestDashboard" class="hidden container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6 border-2 border-blue-200">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-blue-800">Data Absensi Siswa</h2>
                    <p class="text-blue-600 text-sm mt-1">üìÖ <span id="guestDate"></span></p>
                </div>
                <button onclick="logout()" class="bg-blue-700 hover:bg-blue-800 text-white px-4 py-2 rounded-lg border-2 border-yellow-400">Kembali</button>
            </div>
            <p class="text-blue-600">Akses Pengunjung - Hanya dapat melihat data absensi</p>
        </div>
        
        <div id="guestContent"></div>
    </div>

    <!-- Footer dengan Running Text -->
    <footer class="bg-gray-600 mt-8 fixed bottom-0 left-0 right-0 z-40">
        <div class="overflow-hidden py-4">
            <div class="flex items-center animate-scroll whitespace-nowrap">
                <!-- Konten yang akan berulang -->
                <div class="flex items-center space-x-4 mr-12">
                    <img src="https://iili.io/FSNupqu.png" alt="Logo Sekolah" class="w-10 h-10 object-contain">
                    <span class="text-white font-medium text-xl">UPTD SDN 2 TANJUNG QENCONO</span>
                </div>
                
                <!-- Duplikasi untuk efek seamless -->
                <div class="flex items-center space-x-4 mr-12">
                    <img src="https://iili.io/FSNupqu.png" alt="Logo Sekolah" class="w-10 h-10 object-contain">
                    <span class="text-white font-medium text-xl">UPTD SDN 2 TANJUNG QENCONO</span>
                </div>
                
                <!-- Duplikasi ketiga untuk efek yang lebih smooth -->
                <div class="flex items-center space-x-4 mr-12">
                    <img src="https://iili.io/FSNupqu.png" alt="Logo Sekolah" class="w-10 h-10 object-contain">
                    <span class="text-white font-medium text-xl">UPTD SDN 2 TANJUNG QENCONO</span>
                </div>
            </div>
        </div>
    </footer>

    <script>
        let currentUser = null;
        let currentRole = null;
        const API_URL = 'https://script.google.com/macros/s/AKfycbwiJip2pVyE4kCqL1KC1pT46sxoMtTiSPPGZ1nA0Dhi3z3vXS8EyevIJe_NRriRoVkI/exec';

        // Data user sistem (default)
        let userData = {
            admin: {
                username: 'admin',
                password: 'admin123',
                role: 'admin',
                name: 'Administrator Sekolah'
            },
            guru: {
                guruku1: { username: 'guruku1', password: 'guruku1', role: 'guru', kelas: '1', name: 'Guru Kelas 1' },
                guruku2: { username: 'guruku2', password: 'guruku2', role: 'guru', kelas: '2', name: 'Guru Kelas 2' },
                guruku3: { username: 'guruku3', password: 'guruku3', role: 'guru', kelas: '3', name: 'Guru Kelas 3' },
                guruku4: { username: 'guruku4', password: 'guruku4', role: 'guru', kelas: '4', name: 'Guru Kelas 4' },
                guruku5: { username: 'guruku5', password: 'guruku5', role: 'guru', kelas: '5', name: 'Guru Kelas 5' },
                guruku6: { username: 'guruku6', password: 'guruku6', role: 'guru', kelas: '6', name: 'Guru Kelas 6' }
            },
            waliKelas: {}
        };

        // Data siswa per kelas (diurutkan berdasarkan abjad)
        const siswaData = {
            1: [
                {nis: '006', nama: 'ADINDA AYSILLA HUSNA'},
                {nis: '008', nama: 'AMIRUDDIN MAJID UBAIDILLAH'},
                {nis: '010', nama: 'ARVINO ADITAMA RAMADHAN'},
                {nis: '009', nama: 'AZRIL REVAN SYAFRUDUN'},
                {nis: '004', nama: 'ELVAN SYAHREZA'},
                {nis: '003', nama: 'MUHAMMAD SYARIF HIDAYAT'},
                {nis: '001', nama: 'NATHAN ARKA DIO ANTONI'},
                {nis: '007', nama: 'RAKA ANGGARA PUTRA'},
                {nis: '002', nama: 'RISQY ADITIA SAPUTRA'},
                {nis: '005', nama: 'RONA AIZA SANSA'},
                {nis: '011', nama: 'WANDA MARTIN SAFITRI'}
            ],
            2: [
                {nis: '3170507080', nama: 'ALGIS GANENDRA CLEO'},
                {nis: '3175485485', nama: 'AMANDA KHOIRUL RAMADHAN'},
                {nis: '3170382230', nama: 'ATMAWATI ANJANI'},
                {nis: '3168382820', nama: 'DELVIA FATMAY PUTRI'},
                {nis: '3172553543', nama: 'EVAN FAUZAN PRANATA'},
                {nis: '3174668335', nama: 'HAFIDZAH NAYLA PUTRI'},
                {nis: '3173335134', nama: 'HAFIZ MAULANA AKBAR'},
                {nis: '3173959904', nama: 'KHETRIN KHOIRUNISSA AL FATIH'},
                {nis: '3173454307', nama: 'KHOLIFAH KAILA RAHMADANI'},
                {nis: '3173274219', nama: 'MUHAMAD AL\'FA SYAHRAN UZWIN'},
                {nis: '3170041531', nama: 'MUHAMAD YUSUF NOVRIYANTO'},
                {nis: '3172671049', nama: 'MUHAMMAD AZKA PUTRA'},
                {nis: '3178324639', nama: 'MUHAMMAD KHAIRUL AZZAM'},
                {nis: '3171384445', nama: 'NADIRA AZZAHRA'},
                {nis: '3175018332', nama: 'REVANIA SARI'},
                {nis: '3171318451', nama: 'SALMAN ALFARISY'},
                {nis: '3175292042', nama: 'SILVIA AULIA SAPUTRI'},
                {nis: '3171230493', nama: 'WAHYUNI SRI LESTARI'}
            ],
            3: [
                {nis: '3174584527', nama: 'ADILA KHOIRUNISHA'},
                {nis: '3162887940', nama: 'AKSA DANUARTA'},
                {nis: '3164308000', nama: 'ALIFA HANIF RAMADAN'},
                {nis: '3164627682', nama: 'ARCELLA ADI NINGRUM'},
                {nis: '3160303851', nama: 'CHEREL KHALISA BILQIS'},
                {nis: '3160200932', nama: 'CLARA AQILA NUR KHADIJAH'},
                {nis: '3179791023', nama: 'FAIZ ATHAYA NAREZWARA'},
                {nis: '3176266752', nama: 'FAIZ FERDIANSYAH'},
                {nis: '3166042800', nama: 'HILDA RIZKI ISLAMI'},
                {nis: '3168521799', nama: 'MEIDA HAFIZAH'},
                {nis: '3165251243', nama: 'MUHAMAD JAMAL'},
                {nis: '3165184889', nama: 'MUHAMAD JAMIL'},
                {nis: '3160850470', nama: 'MUHAMMAD DAFA ALHABSYI'},
                {nis: '3160603616', nama: 'NANDA ARISKA RARASATI'},
                {nis: '3166872711', nama: 'NAURA IZZATU ANNISA'},
                {nis: '3176100007', nama: 'RASID RIZKY RAMADAN'},
                {nis: '3173969287', nama: 'RIZKIYA DIANA PUTRI'},
                {nis: '3167585938', nama: 'SEPTA KURNIAWAN'}
            ],
            4: [
                {nis: '3157397909', nama: 'ADITYA RIFQI ARDANI'},
                {nis: '3150024087', nama: 'AHMAD ASMARAHMAN'},
                {nis: '3140625800', nama: 'ALIANDO SAPUTRA'},
                {nis: '3153920132', nama: 'ANINDYA KEISYHA RAMADHANI'},
                {nis: '3152904052', nama: 'DESVIANA NUR ALIFAH'},
                {nis: '3158201873', nama: 'DIKI ARDIANSYAH'},
                {nis: '153019216', nama: 'ELSA PUTRI CAROLINA'},
                {nis: '3152017021', nama: 'FERNANDA ARYA PRIANDARU'},
                {nis: '3151662644', nama: 'KEYLA CITRA ANGGELITTA'},
                {nis: '3167129859', nama: 'NAILA AZIZAH'},
                {nis: '3151518656', nama: 'PENDI MOHAMAT SAPUTRA'},
                {nis: '3159460011', nama: 'SAVIRA ENJELINA'},
                {nis: '3150354056', nama: 'VALENCIA NATHANIELA'}
            ],
            5: [
                {nis: '3149188588', nama: 'ADZKIA SAMHA SAUFA SOFYAN'},
                {nis: '3141542009', nama: 'BAGAS HANIF RAJENDRA'},
                {nis: '146416397', nama: 'DIFKI RAMA ADITYA'},
                {nis: '3141604051', nama: 'GAGAH ILYAS PRATAMA'},
                {nis: '143277382', nama: 'GALANG SAPUTRA'},
                {nis: '145447639', nama: 'HAFIDZ FATHULAH'},
                {nis: '147089621', nama: 'HUSNA NURI RAMADHANI'},
                {nis: '3152084061', nama: 'MUHAMMAD BAIHAQI'},
                {nis: '145476995', nama: 'ZAKKY ADHA JEPRIANTO'}
            ],
            6: [
                {nis: '133869162', nama: 'ALESHA RAFANI BURAHMAN'},
                {nis: '142959538', nama: 'ANDRIAN SAPUTRA'},
                {nis: '143162950', nama: 'CLEA ANISA RANI'},
                {nis: '149485885', nama: 'FITRIA AMANDA'},
                {nis: '138217230', nama: 'HIJASUL AZAM ZAMI'},
                {nis: '138377451', nama: 'KEREN AULIA VENETA'},
                {nis: '144711812', nama: 'LULUK FAJAR ARIYANI'},
                {nis: '141013511', nama: 'MALIKA AURORA ENJELICA'},
                {nis: '132129915', nama: 'RAFA SURYA NURHIDAYAT'},
                {nis: '144463888', nama: 'REHAN DEFA SAPUTRA'},
                {nis: '143631939', nama: 'REVAN DEFA SAPUTRA'},
                {nis: '144753098', nama: 'SALSABILA RAMADHANI'},
                {nis: '136217115', nama: 'SYAHRUL WAHYUDA MAULANA'}
            ]
        };

        function showLoginForm(type) {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('loginForm').classList.add('fade-in');
            currentRole = type;
        }

        function hideLoginForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function togglePassword() {
            const passwordField = document.getElementById('password');
            const eyeIcon = document.getElementById('eyeIcon');
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                eyeIcon.textContent = 'üôà';
            } else {
                passwordField.type = 'password';
                eyeIcon.textContent = 'üëÅÔ∏è';
            }
        }

        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                alert('Mohon isi username dan password!');
                return;
            }

            // Validasi login
            if (currentRole === 'admin') {
                if (username === userData.admin.username && password === userData.admin.password) {
                    currentUser = username;
                    showDashboard('admin');
                } else {
                    alert('Username atau password admin tidak valid!');
                }
            } else if (currentRole === 'guru') {
                // Cek guru biasa
                const guruUser = userData.guru[username];
                if (guruUser && guruUser.password === password) {
                    currentUser = username;
                    showDashboard('guru', guruUser.kelas);
                } 
                // Cek wali kelas
                else if (userData.waliKelas[username] && userData.waliKelas[username].password === password) {
                    currentUser = username;
                    showDashboard('guru', userData.waliKelas[username].kelas);
                } else {
                    alert('Username atau password guru tidak valid!');
                }
            } else {
                alert('Username atau password salah!');
            }
        }

        function guestLogin() {
            currentUser = 'guest';
            currentRole = 'guest';
            showDashboard('guest');
        }

        function showDashboard(role, kelas = null) {
            document.getElementById('loginPage').classList.add('hidden');
            
            // Update tanggal di semua dashboard
            updateDashboardDate();
            
            // Load data sistem terbaru dari server saat login
            loadSystemDataFromServer().then(() => {
                if (role === 'admin') {
                    document.getElementById('adminDashboard').classList.remove('hidden');
                    showDataAbsensi();
                } else if (role === 'guru') {
                    document.getElementById('guruDashboard').classList.remove('hidden');
                    
                    // Cari nama user yang sedang login (dengan data terbaru)
                    let userName = `Guru Kelas ${kelas}`;
                    if (userData.guru[currentUser]) {
                        userName = userData.guru[currentUser].name;
                    } else if (userData.waliKelas[currentUser]) {
                        userName = userData.waliKelas[currentUser].name;
                    }
                    
                    document.getElementById('guruName').textContent = userName;
                    showAbsensiFormGuru(kelas);
                } else if (role === 'guest') {
                    document.getElementById('guestDashboard').classList.remove('hidden');
                    showDataAbsensiGuest();
                }
            });
        }

        function updateDashboardDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                timeZone: 'Asia/Jakarta'
            };
            const dateString = now.toLocaleDateString('id-ID', options);
            const timeString = now.toLocaleTimeString('id-ID', { 
                hour: '2-digit', 
                minute: '2-digit',
                timeZone: 'Asia/Jakarta'
            });
            
            const fullDateTime = `${dateString}, ${timeString} WIB`;
            
            // Update semua elemen tanggal
            const dateElements = ['adminDate', 'guruDate', 'guestDate'];
            dateElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = fullDateTime;
                }
            });
        }

        function logout() {
            // Simpan state terakhir sebelum logout
            saveCurrentState();
            
            currentUser = null;
            currentRole = null;
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('guruDashboard').classList.add('hidden');
            document.getElementById('guestDashboard').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
            hideLoginForm();
        }

        function showAbsensiForm() {
            // Buat daftar semua siswa dengan kelas
            let allSiswaOptions = '<option value="">Pilih Siswa</option>';
            Object.keys(siswaData).forEach(kelas => {
                allSiswaOptions += `<optgroup label="=== KELAS ${kelas} ===">`;
                siswaData[kelas].forEach(siswa => {
                    allSiswaOptions += `<option value="${siswa.nis}|${siswa.nama}|${kelas}">${siswa.nama} (${siswa.nis}) - Kelas ${kelas}</option>`;
                });
                allSiswaOptions += '</optgroup>';
            });

            const content = `
                <div class="bg-white rounded-lg shadow-lg p-6 border-2 border-blue-200">
                    <h3 class="text-xl font-bold mb-4 text-blue-800">Input Absensi Siswa</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-blue-800 font-medium mb-2">Pilih Siswa</label>
                            <select id="siswaSelect" class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400">
                                ${allSiswaOptions}
                            </select>
                        </div>
                        <div>
                            <label class="block text-blue-800 font-medium mb-2">Keterangan</label>
                            <select id="keterangan" class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400">
                                <option value="Hadir">Hadir</option>
                                <option value="Sakit">Sakit</option>
                                <option value="Izin">Izin</option>
                                <option value="Alpa">Alpa</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <button onclick="submitAbsensi()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-blue-800 py-2 px-4 rounded-lg font-medium border-2 border-blue-300">
                                Simpan Absensi
                            </button>
                        </div>
                    </div>
                    <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <p class="text-sm text-blue-700">üíæ Data form disimpan otomatis setiap kali ada perubahan</p>
                    </div>
                </div>
            `;
            document.getElementById('adminContent').innerHTML = content;
            
            // Setup auto-save untuk form yang baru dibuat
            setTimeout(setupAutoSave, 100);
        }

        function showAbsensiFormGuru(kelas) {
            const siswa = siswaData[kelas] || [];
            const today = new Date().toLocaleDateString('id-ID');
            
            const content = `
                <div class="bg-white rounded-lg shadow-lg p-6 border-2 border-blue-200">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-blue-800">Absensi Kelas ${kelas}</h3>
                        <div class="text-sm text-blue-600 bg-blue-100 px-3 py-1 rounded">
                            üìÖ ${today}
                        </div>
                    </div>
                    
                    <div class="mb-4 flex flex-wrap gap-2">
                        <button onclick="markAllPresent(${kelas})" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm border-2 border-green-400">
                            ‚úÖ Tandai Semua Hadir
                        </button>
                        <button onclick="clearTodayAttendance(${kelas})" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg text-sm border-2 border-yellow-400">
                            üîÑ Reset Absensi Hari Ini
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border-2 border-blue-300 rounded-lg">
                            <thead class="bg-blue-100">
                                <tr>
                                    <th class="px-4 py-3 border-b-2 border-blue-300 text-left text-blue-800 font-bold">No</th>
                                    <th class="px-4 py-3 border-b-2 border-blue-300 text-left text-blue-800 font-bold">NIS</th>
                                    <th class="px-4 py-3 border-b-2 border-blue-300 text-left text-blue-800 font-bold">Nama Siswa</th>
                                    <th class="px-4 py-3 border-b-2 border-blue-300 text-center text-blue-800 font-bold">Kehadiran</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${siswa.map((s, index) => `
                                    <tr class="hover:bg-yellow-50 border-b border-blue-200">
                                        <td class="px-4 py-3 text-center font-medium text-blue-800">${index + 1}</td>
                                        <td class="px-4 py-3 font-medium text-blue-700">${s.nis}</td>
                                        <td class="px-4 py-3 font-medium text-blue-800">${s.nama}</td>
                                        <td class="px-4 py-3 text-center">
                                            <div class="flex items-center justify-center space-x-2">
                                                <select id="attendance_${s.nis}" class="px-3 py-2 border-2 border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 text-sm font-medium attendance-select" onchange="updateAttendanceStatus('${s.nis}')">
                                                    <option value="">-- Pilih --</option>
                                                    <option value="Hadir" class="text-green-600">‚úÖ Hadir</option>
                                                    <option value="Sakit" class="text-yellow-600">ü§í Sakit</option>
                                                    <option value="Izin" class="text-blue-600">üìù Izin</option>
                                                    <option value="Alpa" class="text-red-600">‚ùå Alpa</option>
                                                </select>
                                                <button onclick="submitSingleAttendance('${s.nis}', '${s.nama}', ${kelas})" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs border border-blue-400" title="Simpan absensi ${s.nama}">
                                                    üíæ
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <h4 class="font-bold text-blue-800 mb-2">üìã Petunjuk Penggunaan:</h4>
                        <ul class="text-sm text-blue-700 space-y-1">
                            <li>‚Ä¢ Pilih status kehadiran untuk setiap siswa dari dropdown</li>
                            <li>‚Ä¢ Klik tombol üíæ di sebelah dropdown untuk menyimpan absensi siswa tersebut</li>
                            <li>‚Ä¢ Gunakan tombol "Tandai Semua Hadir" untuk mengatur semua siswa sebagai hadir sekaligus</li>
                            <li>‚Ä¢ Status akan berubah warna: Hijau (Hadir), Kuning (Sakit), Biru (Izin), Merah (Alpa)</li>
                            <li>‚Ä¢ Data absensi akan tersimpan otomatis dan tidak hilang saat halaman di-refresh</li>
                        </ul>
                    </div>

                    <div class="mt-4 p-3 bg-green-50 rounded-lg border border-green-200">
                        <p class="text-sm text-green-700">
                            <span class="font-medium">üìä Status:</span> 
                            <span id="attendanceStatus">Siap untuk input absensi</span>
                        </p>
                    </div>
                </div>
            `;
            document.getElementById('guruContent').innerHTML = content;
            
            // Setup event listeners dan restore data absensi hari ini
            setTimeout(() => {
                setupAttendanceColorChange();
                restoreTodayAttendance(kelas);
            }, 100);
        }



        function submitAbsensi() {
            const siswaData = document.getElementById('siswaSelect').value;
            const keterangan = document.getElementById('keterangan').value;

            if (!siswaData || !keterangan) {
                alert('Mohon lengkapi semua data!');
                return;
            }

            const [nis, nama, kelas] = siswaData.split('|');
            
            const data = {
                nis: nis,
                nama: nama,
                kelas: `Kelas ${kelas}`,
                keterangan: keterangan
            };

            sendToGoogleSheets(data);
        }

        function submitAbsensiGuru(kelas) {
            const siswaData = document.getElementById('siswaSelectGuru').value;
            const keterangan = document.getElementById('keteranganGuru').value;

            if (!siswaData || !keterangan) {
                alert('Mohon lengkapi semua data!');
                return;
            }

            const [nis, nama] = siswaData.split('|');
            
            const data = {
                nis: nis,
                nama: nama,
                kelas: `Kelas ${kelas}`,
                keterangan: keterangan
            };

            sendToGoogleSheets(data);
        }

        // Fungsi untuk menandai semua siswa hadir
        function markAllPresent(kelas) {
            const selects = document.querySelectorAll('.attendance-select');
            selects.forEach(select => {
                select.value = 'Hadir';
                updateAttendanceStatus(select.id.replace('attendance_', ''));
            });
            updateStatusMessage('Semua siswa ditandai hadir');
        }



        // Fungsi untuk menyimpan absensi individual
        function submitSingleAttendance(nis, nama, kelas) {
            const attendanceSelect = document.getElementById(`attendance_${nis}`);
            const keterangan = attendanceSelect.value;

            if (!keterangan) {
                alert(`Mohon pilih status kehadiran untuk ${nama} terlebih dahulu!`);
                attendanceSelect.focus();
                return;
            }

            const data = {
                nis: nis,
                nama: nama,
                kelas: `Kelas ${kelas}`,
                keterangan: keterangan
            };

            sendToGoogleSheets(data);
        }



        // Fungsi untuk mengupdate status warna dropdown
        function updateAttendanceStatus(nis) {
            const select = document.getElementById(`attendance_${nis}`);
            const value = select.value;
            
            // Reset style
            select.style.backgroundColor = '';
            select.style.color = '';
            select.style.fontWeight = 'bold';
            
            // Set warna berdasarkan pilihan
            switch(value) {
                case 'Hadir':
                    select.style.backgroundColor = '#dcfce7'; // green-100
                    select.style.color = '#166534'; // green-800
                    select.style.borderColor = '#22c55e'; // green-500
                    break;
                case 'Sakit':
                    select.style.backgroundColor = '#fef3c7'; // yellow-100
                    select.style.color = '#92400e'; // yellow-800
                    select.style.borderColor = '#f59e0b'; // yellow-500
                    break;
                case 'Izin':
                    select.style.backgroundColor = '#dbeafe'; // blue-100
                    select.style.color = '#1e40af'; // blue-800
                    select.style.borderColor = '#3b82f6'; // blue-500
                    break;
                case 'Alpa':
                    select.style.backgroundColor = '#fee2e2'; // red-100
                    select.style.color = '#991b1b'; // red-800
                    select.style.borderColor = '#ef4444'; // red-500
                    break;
                default:
                    select.style.borderColor = '#93c5fd'; // blue-300
            }
            
            // Simpan status absensi hari ini
            saveTodayAttendanceStatus(nis, value);
        }

        // Fungsi untuk menyimpan status absensi hari ini
        function saveTodayAttendanceStatus(nis, status) {
            const today = new Date().toISOString().split('T')[0]; // Format YYYY-MM-DD
            const storageKey = `attendance_${today}`;
            
            try {
                let todayAttendance = JSON.parse(localStorage.getItem(storageKey) || '{}');
                
                if (status && status !== '') {
                    todayAttendance[nis] = status;
                } else {
                    delete todayAttendance[nis];
                }
                
                localStorage.setItem(storageKey, JSON.stringify(todayAttendance));
                console.log(`Status absensi ${nis} disimpan: ${status}`);
            } catch (error) {
                console.error('Error saving today attendance status:', error);
            }
        }

        // Fungsi untuk memulihkan status absensi hari ini
        function restoreTodayAttendance(kelas) {
            const today = new Date().toISOString().split('T')[0]; // Format YYYY-MM-DD
            const storageKey = `attendance_${today}`;
            
            try {
                const todayAttendance = JSON.parse(localStorage.getItem(storageKey) || '{}');
                const siswaKelas = siswaData[kelas] || [];
                
                let restoredCount = 0;
                siswaKelas.forEach(siswa => {
                    const select = document.getElementById(`attendance_${siswa.nis}`);
                    if (select && todayAttendance[siswa.nis]) {
                        select.value = todayAttendance[siswa.nis];
                        updateAttendanceStatus(siswa.nis);
                        restoredCount++;
                    }
                });
                
                if (restoredCount > 0) {
                    updateStatusMessage(`Memulihkan ${restoredCount} data absensi hari ini`);
                    console.log(`Dipulihkan ${restoredCount} status absensi untuk kelas ${kelas}`);
                }
            } catch (error) {
                console.error('Error restoring today attendance:', error);
            }
        }

        // Fungsi untuk menghapus absensi hari ini
        function clearTodayAttendance(kelas) {
            if (confirm('Apakah Anda yakin ingin menghapus semua data absensi hari ini?\n\nData yang sudah tersimpan di Google Sheets tidak akan terhapus.')) {
                const today = new Date().toISOString().split('T')[0];
                const storageKey = `attendance_${today}`;
                
                try {
                    // Hapus dari localStorage
                    localStorage.removeItem(storageKey);
                    
                    // Reset semua dropdown
                    const siswaKelas = siswaData[kelas] || [];
                    siswaKelas.forEach(siswa => {
                        const select = document.getElementById(`attendance_${siswa.nis}`);
                        if (select) {
                            select.value = '';
                            updateAttendanceStatus(siswa.nis);
                        }
                    });
                    
                    updateStatusMessage('Data absensi hari ini telah dihapus');
                    alert('‚úÖ Data absensi hari ini berhasil dihapus!\n\nAnda dapat mulai input absensi dari awal.');
                } catch (error) {
                    console.error('Error clearing today attendance:', error);
                    alert('‚ùå Gagal menghapus data absensi hari ini.');
                }
            }
        }

        // Fungsi untuk setup event listeners
        function setupAttendanceColorChange() {
            const selects = document.querySelectorAll('.attendance-select');
            selects.forEach(select => {
                select.addEventListener('change', function() {
                    const nis = this.id.replace('attendance_', '');
                    updateAttendanceStatus(nis);
                });
            });
        }

        // Fungsi untuk mengupdate pesan status
        function updateStatusMessage(message) {
            const statusElement = document.getElementById('attendanceStatus');
            if (statusElement) {
                statusElement.textContent = message;
                
                // Reset ke pesan default setelah 3 detik
                setTimeout(() => {
                    statusElement.textContent = 'Siap untuk input absensi';
                }, 3000);
            }
        }

        function sendToGoogleSheets(data, silentSync = false) {
            // Data akan dikirim tanpa timestamp karena Apps Script akan menambahkan otomatis
            const dataToSend = {
                nis: data.nis,
                nama: data.nama,
                kelas: data.kelas,
                keterangan: data.keterangan
            };
            
            // Untuk penyimpanan lokal, tetap tambahkan timestamp
            const now = new Date();
            const tanggal = now.toLocaleDateString('id-ID', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            const waktu = now.toLocaleTimeString('id-ID', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            const timestamp = `${tanggal} ${waktu}`;
            
            const dataWithTimestamp = {
                ...data,
                tanggal: tanggal,
                waktu: waktu,
                timestamp: timestamp,
                id: data.id || Date.now() + '_' + Math.random().toString(36).substr(2, 9)
            };

            // Simpan data ke localStorage terlebih dahulu
            saveToLocalStorage(dataWithTimestamp);

            // Tampilkan loading hanya jika bukan silent sync
            let loadingMsg;
            if (!silentSync) {
                loadingMsg = document.createElement('div');
                loadingMsg.id = 'loadingMsg';
                loadingMsg.className = 'fixed top-4 right-4 bg-blue-600 text-white px-4 py-2 rounded-lg z-50';
                loadingMsg.textContent = 'Menyimpan data...';
                document.body.appendChild(loadingMsg);
            }

            fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(dataToSend)
            })
            .then(() => {
                // Karena mode no-cors, kita tidak bisa membaca response
                // Tapi kita asumsikan berhasil jika tidak ada error
                if (loadingMsg) {
                    loadingMsg.remove();
                }
                
                // Hapus dari pending sync jika berhasil
                if (dataWithTimestamp.id) {
                    removeSyncedData(dataWithTimestamp.id);
                }
                
                if (!silentSync) {
                    alert('Data absensi berhasil disimpan!');
                    
                    // Reset form
                    resetForms();
                    
                    // Auto refresh data jika sedang menampilkan tabel
                    setTimeout(refreshCurrentView, 1000);
                }
                
                // Backup data setelah berhasil sync
                backupDataToMultipleStorage();
            })
            .catch(error => {
                console.error('Error:', error);
                if (loadingMsg) {
                    loadingMsg.remove();
                }
                
                // Simpan ke pending sync untuk dicoba lagi nanti
                savePendingSyncData(dataWithTimestamp);
                
                if (!silentSync) {
                    alert('Data absensi berhasil disimpan secara lokal!\n\nCatatan: Data akan otomatis sinkron ke Google Sheets saat koneksi tersedia.');
                    
                    // Reset form
                    resetForms();
                    
                    // Auto refresh data jika sedang menampilkan tabel
                    setTimeout(refreshCurrentView, 1000);
                }
            });
        }

        // Fungsi helper untuk reset form
        function resetForms() {
            if (document.getElementById('siswaSelect')) {
                document.getElementById('siswaSelect').value = '';
                document.getElementById('keterangan').value = 'Hadir';
            }
            if (document.getElementById('siswaSelectGuru')) {
                document.getElementById('siswaSelectGuru').value = '';
                document.getElementById('keteranganGuru').value = 'Hadir';
            }
        }

        function showDataAbsensi() {
            const today = new Date().toISOString().split('T')[0];
            const content = `
                <div class="bg-white rounded-lg shadow-lg p-6 border-2 border-blue-200">
                    <h3 class="text-xl font-bold mb-4 text-blue-800">Data Absensi Siswa</h3>
                    
                    <!-- Filter Section -->
                    <div class="mb-6 p-4 bg-blue-50 border-2 border-blue-200 rounded-lg">
                        <h4 class="font-bold text-blue-800 mb-3">üîç Filter Data Absensi</h4>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-blue-800 font-medium mb-2">Tanggal</label>
                                <input type="date" id="filterTanggal" value="${today}" class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400">
                            </div>
                            <div>
                                <label class="block text-blue-800 font-medium mb-2">Kelas</label>
                                <select id="filterKelas" class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400">
                                    <option value="">Semua Kelas</option>
                                    <option value="Kelas 1">Kelas 1</option>
                                    <option value="Kelas 2">Kelas 2</option>
                                    <option value="Kelas 3">Kelas 3</option>
                                    <option value="Kelas 4">Kelas 4</option>
                                    <option value="Kelas 5">Kelas 5</option>
                                    <option value="Kelas 6">Kelas 6</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-blue-800 font-medium mb-2">Status</label>
                                <select id="filterStatus" class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400">
                                    <option value="">Semua Status</option>
                                    <option value="Hadir">Hadir</option>
                                    <option value="Sakit">Sakit</option>
                                    <option value="Izin">Izin</option>
                                    <option value="Alpa">Alpa</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button onclick="filterAbsensiData()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-blue-800 px-4 py-2 rounded-lg border-2 border-blue-300 font-medium">
                                    üîç Cari Data
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-4 flex flex-wrap gap-2">
                            <button onclick="loadAbsensiData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg border-2 border-blue-400 text-sm">
                                üìä Tampilkan Semua Data
                            </button>
                        </div>
                    </div>

                    <!-- Results Info -->
                    <div id="resultsInfo" class="mb-4 p-3 bg-gray-50 border border-gray-200 rounded-lg hidden">
                        <p class="text-sm text-gray-700"><span id="resultsText"></span></p>
                    </div>
                    
                    <div id="absensiTable" class="overflow-x-auto">
                        <p class="text-blue-600">Gunakan filter di atas untuk mencari data absensi atau klik "Tampilkan Semua Data"</p>
                    </div>
                </div>
            `;
            document.getElementById('adminContent').innerHTML = content;
        }

        function showDataAbsensiGuest() {
            const today = new Date().toISOString().split('T')[0];
            const content = `
                <div class="bg-white rounded-lg shadow-lg p-6 border-2 border-blue-200">
                    <h3 class="text-xl font-bold mb-4 text-blue-800">Data Absensi Siswa</h3>
                    
                    <!-- Filter Section for Guest -->
                    <div class="mb-6 p-4 bg-green-50 border-2 border-green-200 rounded-lg">
                        <h4 class="font-bold text-green-800 mb-3">üîç Filter Data Absensi</h4>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-green-800 font-medium mb-2">Tanggal</label>
                                <input type="date" id="filterTanggalGuest" value="${today}" class="w-full px-3 py-2 border-2 border-green-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-green-400">
                            </div>
                            <div>
                                <label class="block text-green-800 font-medium mb-2">Kelas</label>
                                <select id="filterKelasGuest" class="w-full px-3 py-2 border-2 border-green-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-green-400">
                                    <option value="">Semua Kelas</option>
                                    <option value="Kelas 1">Kelas 1</option>
                                    <option value="Kelas 2">Kelas 2</option>
                                    <option value="Kelas 3">Kelas 3</option>
                                    <option value="Kelas 4">Kelas 4</option>
                                    <option value="Kelas 5">Kelas 5</option>
                                    <option value="Kelas 6">Kelas 6</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-green-800 font-medium mb-2">Status</label>
                                <select id="filterStatusGuest" class="w-full px-3 py-2 border-2 border-green-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-green-400">
                                    <option value="">Semua Status</option>
                                    <option value="Hadir">Hadir</option>
                                    <option value="Sakit">Sakit</option>
                                    <option value="Izin">Izin</option>
                                    <option value="Alpa">Alpa</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button onclick="filterAbsensiDataGuest()" class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg border-2 border-green-400 font-medium">
                                    üîç Cari Data
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-4 flex flex-wrap gap-2">
                            <button onclick="loadAbsensiDataGuest()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg border-2 border-blue-400 text-sm">
                                üìä Tampilkan Semua Data
                            </button>
                        </div>
                    </div>

                    <!-- Results Info for Guest -->
                    <div id="resultsInfoGuest" class="mb-4 p-3 bg-gray-50 border border-gray-200 rounded-lg hidden">
                        <p class="text-sm text-gray-700"><span id="resultsTextGuest"></span></p>
                    </div>
                    
                    <div id="absensiTableGuest" class="overflow-x-auto">
                        <p class="text-blue-600">Gunakan filter di atas untuk mencari data absensi atau klik "Tampilkan Semua Data"</p>
                    </div>
                </div>
            `;
            document.getElementById('guestContent').innerHTML = content;
        }

        function loadAbsensiData() {
            const loadingHTML = '<div class="text-center py-4"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div><p class="mt-2 text-gray-600">Memuat data...</p></div>';
            document.getElementById('absensiTable').innerHTML = loadingHTML;
            
            // Selalu tampilkan data lokal terlebih dahulu untuk responsivitas
            const localData = getLocalAbsensiData();
            displayAbsensiTable(localData, 'absensiTable');
            
            // Kemudian coba ambil data terbaru dari server di background
            loadDataFromServer('absensiTable');
        }

        function loadDataFromServer(containerId) {
            // Coba dengan JSONP terlebih dahulu
            const script = document.createElement('script');
            const callbackName = 'jsonpCallback' + Date.now();
            
            window[callbackName] = function(serverData) {
                // Gabungkan data server dengan data lokal
                const localData = getLocalAbsensiData();
                const combinedData = mergeAbsensiData(localData, serverData);
                
                // Update tampilan dengan data terbaru
                displayAbsensiTable(combinedData, containerId);
                
                // Simpan data server ke localStorage untuk sinkronisasi
                updateLocalDataFromServer(serverData);
                
                document.head.removeChild(script);
                delete window[callbackName];
                
                // Tampilkan indikator data terbaru
                showDataUpdateIndicator(containerId);
            };
            
            script.src = API_URL + '?callback=' + callbackName + '&t=' + Date.now();
            script.onerror = function() {
                // Jika JSONP gagal, coba fetch biasa
                fetch(API_URL + '?t=' + Date.now())
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(serverData => {
                    // Gabungkan data server dengan data lokal
                    const localData = getLocalAbsensiData();
                    const combinedData = mergeAbsensiData(localData, serverData);
                    
                    // Update tampilan dengan data terbaru
                    displayAbsensiTable(combinedData, containerId);
                    
                    // Simpan data server ke localStorage untuk sinkronisasi
                    updateLocalDataFromServer(serverData);
                    
                    // Tampilkan indikator data terbaru
                    showDataUpdateIndicator(containerId);
                })
                .catch(error => {
                    console.error('Error loading from server:', error);
                    // Tetap tampilkan data lokal dengan peringatan
                    const localData = getLocalAbsensiData();
                    if (localData.length > 0) {
                        displayAbsensiTable(localData, containerId);
                        const container = document.getElementById(containerId);
                        if (container && !container.innerHTML.includes('Menampilkan data lokal')) {
                            container.innerHTML += `
                                <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                    <p class="text-sm text-yellow-700">‚ö†Ô∏è Menampilkan data lokal - tidak dapat terhubung ke Google Sheets</p>
                                </div>
                            `;
                        }
                    }
                });
                document.head.removeChild(script);
                delete window[callbackName];
            };
            
            document.head.appendChild(script);
        }

        // Fungsi untuk menggabungkan data lokal dan server
        function mergeAbsensiData(localData, serverData) {
            if (!serverData || serverData.length === 0) {
                return localData;
            }
            
            // Buat map dari data server berdasarkan kombinasi unik
            const serverMap = new Map();
            serverData.forEach(item => {
                const key = `${item.nis}_${item.tanggal}_${item.keterangan}`;
                serverMap.set(key, item);
            });
            
            // Tambahkan data lokal yang tidak ada di server
            const combinedData = [...serverData];
            localData.forEach(localItem => {
                const key = `${localItem.nis}_${localItem.tanggal}_${localItem.keterangan}`;
                if (!serverMap.has(key)) {
                    combinedData.push(localItem);
                }
            });
            
            // Urutkan berdasarkan timestamp terbaru
            return combinedData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }

        // Fungsi untuk update data lokal dari server
        function updateLocalDataFromServer(serverData) {
            if (!serverData || serverData.length === 0) return;
            
            try {
                const localData = getLocalAbsensiData();
                const mergedData = mergeAbsensiData(localData, serverData);
                
                // Batasi data maksimal 2000 record untuk performa
                const limitedData = mergedData.slice(0, 2000);
                
                localStorage.setItem('absensiData', JSON.stringify(limitedData));
                console.log(`Data lokal diperbarui dengan ${serverData.length} record dari server`);
            } catch (error) {
                console.error('Error updating local data from server:', error);
            }
        }

        // Fungsi untuk menampilkan indikator data terbaru
        function showDataUpdateIndicator(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // Hapus indikator lama jika ada
            const oldIndicator = container.querySelector('.data-update-indicator');
            if (oldIndicator) {
                oldIndicator.remove();
            }
            
            // Tambahkan indikator baru
            const indicator = document.createElement('div');
            indicator.className = 'data-update-indicator mt-2 p-2 bg-green-50 border border-green-200 rounded-lg text-center';
            indicator.innerHTML = `
                <p class="text-sm text-green-700">
                    ‚úÖ Data diperbarui pada ${new Date().toLocaleTimeString('id-ID')}
                </p>
            `;
            
            container.appendChild(indicator);
            
            // Hapus indikator setelah 5 detik
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.remove();
                }
            }, 5000);
        }

        function loadAbsensiDataGuest() {
            const loadingHTML = '<div class="text-center py-4"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div><p class="mt-2 text-gray-600">Memuat data...</p></div>';
            document.getElementById('absensiTableGuest').innerHTML = loadingHTML;
            
            // Selalu tampilkan data lokal terlebih dahulu untuk responsivitas
            const localData = getLocalAbsensiData();
            displayAbsensiTable(localData, 'absensiTableGuest');
            
            // Kemudian coba ambil data terbaru dari server di background
            loadDataFromServer('absensiTableGuest');
        }

        function displayAbsensiTable(data, containerId, showSummary = false) {
            if (!data || data.length === 0) {
                document.getElementById(containerId).innerHTML = '<p class="text-gray-600">Belum ada data absensi</p>';
                return;
            }

            // Hitung statistik jika diminta
            let summaryHTML = '';
            if (showSummary) {
                const stats = {
                    total: data.length,
                    hadir: data.filter(d => d.keterangan === 'Hadir').length,
                    sakit: data.filter(d => d.keterangan === 'Sakit').length,
                    izin: data.filter(d => d.keterangan === 'Izin').length,
                    alpa: data.filter(d => d.keterangan === 'Alpa').length
                };

                summaryHTML = `
                    <div class="mb-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                        <h4 class="font-bold text-gray-800 mb-2">üìä Ringkasan Data</h4>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-2 text-sm">
                            <div class="bg-blue-100 p-2 rounded text-center">
                                <div class="font-bold text-blue-800">${stats.total}</div>
                                <div class="text-blue-600">Total</div>
                            </div>
                            <div class="bg-green-100 p-2 rounded text-center">
                                <div class="font-bold text-green-800">${stats.hadir}</div>
                                <div class="text-green-600">Hadir</div>
                            </div>
                            <div class="bg-yellow-100 p-2 rounded text-center">
                                <div class="font-bold text-yellow-800">${stats.sakit}</div>
                                <div class="text-yellow-600">Sakit</div>
                            </div>
                            <div class="bg-blue-100 p-2 rounded text-center">
                                <div class="font-bold text-blue-800">${stats.izin}</div>
                                <div class="text-blue-600">Izin</div>
                            </div>
                            <div class="bg-red-100 p-2 rounded text-center">
                                <div class="font-bold text-red-800">${stats.alpa}</div>
                                <div class="text-red-600">Alpa</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            let tableHTML = summaryHTML + `
                <table class="min-w-full bg-white border-2 border-blue-300">
                    <thead class="bg-blue-100">
                        <tr>
                            <th class="px-4 py-2 border-b-2 border-blue-300 text-left text-blue-800 font-bold">No</th>
                            <th class="px-4 py-2 border-b-2 border-blue-300 text-left text-blue-800 font-bold">Tanggal</th>
                            <th class="px-4 py-2 border-b-2 border-blue-300 text-left text-blue-800 font-bold">Waktu</th>
                            <th class="px-4 py-2 border-b-2 border-blue-300 text-left text-blue-800 font-bold">NIS</th>
                            <th class="px-4 py-2 border-b-2 border-blue-300 text-left text-blue-800 font-bold">Nama Siswa</th>
                            <th class="px-4 py-2 border-b-2 border-blue-300 text-left text-blue-800 font-bold">Kelas</th>
                            <th class="px-4 py-2 border-b-2 border-blue-300 text-left text-blue-800 font-bold">Keterangan</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach((row, index) => {
                const statusClass = row.keterangan === 'Hadir' ? 'text-green-600' : 
                                  row.keterangan === 'Sakit' ? 'text-yellow-600' : 
                                  row.keterangan === 'Izin' ? 'text-blue-600' : 'text-red-600';
                
                // Parse timestamp untuk mendapatkan tanggal dan waktu terpisah
                let tanggal = '';
                let waktu = '';
                if (row.timestamp) {
                    try {
                        const dateTime = new Date(row.timestamp);
                        if (!isNaN(dateTime.getTime())) {
                            tanggal = dateTime.toLocaleDateString('id-ID');
                            waktu = dateTime.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                        } else {
                            // Jika format timestamp berbeda, coba parse manual
                            const parts = row.timestamp.split(' ');
                            if (parts.length >= 2) {
                                tanggal = parts[0];
                                waktu = parts[1];
                            } else {
                                tanggal = row.timestamp;
                                waktu = '-';
                            }
                        }
                    } catch (error) {
                        tanggal = row.timestamp || '';
                        waktu = '-';
                    }
                }
                
                tableHTML += `
                    <tr class="hover:bg-yellow-50 ${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                        <td class="px-4 py-2 border-b border-blue-200 text-sm text-center font-medium">${index + 1}</td>
                        <td class="px-4 py-2 border-b border-blue-200 text-sm">${tanggal}</td>
                        <td class="px-4 py-2 border-b border-blue-200 text-sm">${waktu}</td>
                        <td class="px-4 py-2 border-b border-blue-200 font-medium">${row.nis || ''}</td>
                        <td class="px-4 py-2 border-b border-blue-200 font-medium">${row.nama || ''}</td>
                        <td class="px-4 py-2 border-b border-blue-200 text-center">${row.kelas || ''}</td>
                        <td class="px-4 py-2 border-b border-blue-200 ${statusClass} font-bold text-center">${row.keterangan || ''}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            document.getElementById(containerId).innerHTML = tableHTML;
        }

        function showManageData() {
            const content = `
                <div class="bg-white rounded-lg shadow-lg p-6 border-2 border-blue-200">
                    <h3 class="text-xl font-bold mb-4 text-blue-800">Kelola Data Siswa</h3>
                    
                    <!-- Tombol Aksi -->
                    <div class="mb-6 flex flex-wrap gap-2">
                        <button onclick="showAddStudentForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg border-2 border-green-400 flex items-center space-x-2">
                            <span>‚ûï</span>
                            <span>Tambah Siswa Baru</span>
                        </button>
                    </div>

                    <!-- Form Tambah Siswa (Hidden by default) -->
                    <div id="addStudentForm" class="hidden mb-6 p-4 bg-green-50 border-2 border-green-300 rounded-lg">
                        <h4 class="font-bold text-green-800 mb-3">‚ûï Tambah Siswa Baru</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-green-800 font-medium mb-2">NIS</label>
                                <input type="text" id="newNis" placeholder="Masukkan NIS" class="w-full px-3 py-2 border-2 border-green-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-green-400">
                            </div>
                            <div>
                                <label class="block text-green-800 font-medium mb-2">Nama Siswa</label>
                                <input type="text" id="newNama" placeholder="Masukkan nama lengkap" class="w-full px-3 py-2 border-2 border-green-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-green-400">
                            </div>
                            <div>
                                <label class="block text-green-800 font-medium mb-2">Kelas</label>
                                <select id="newKelas" class="w-full px-3 py-2 border-2 border-green-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-green-400">
                                    <option value="">Pilih Kelas</option>
                                    <option value="1">Kelas 1</option>
                                    <option value="2">Kelas 2</option>
                                    <option value="3">Kelas 3</option>
                                    <option value="4">Kelas 4</option>
                                    <option value="5">Kelas 5</option>
                                    <option value="6">Kelas 6</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4 flex space-x-2">
                            <button onclick="addNewStudent()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg border-2 border-green-400">
                                ‚úÖ Simpan Siswa
                            </button>
                            <button onclick="hideAddStudentForm()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg border-2 border-gray-400">
                                ‚ùå Batal
                            </button>
                        </div>
                    </div>

                    <!-- Data Siswa per Kelas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${Object.keys(siswaData).map(kelas => `
                            <div class="border-2 border-blue-300 rounded-lg p-4 bg-yellow-50">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-bold text-lg text-blue-800">Kelas ${kelas}</h4>
                                    <span class="text-sm text-blue-600 bg-blue-100 px-2 py-1 rounded">${siswaData[kelas].length} siswa</span>
                                </div>
                                <div class="space-y-2 max-h-64 overflow-y-auto">
                                    ${siswaData[kelas].map((siswa, index) => `
                                        <div class="flex justify-between items-center p-2 bg-white rounded border border-blue-200 hover:bg-blue-50">
                                            <div class="flex-1">
                                                <div class="text-sm font-medium text-blue-800">${siswa.nama}</div>
                                                <div class="text-xs text-blue-600">NIS: ${siswa.nis}</div>
                                            </div>
                                            <div class="flex space-x-1">
                                                <button onclick="editStudent('${kelas}', ${index})" class="text-yellow-600 hover:text-yellow-800 p-1" title="Edit Siswa">
                                                    ‚úèÔ∏è
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="mt-6 p-4 bg-blue-100 rounded-lg border-2 border-blue-300">
                        <p class="text-blue-800"><strong>üí° Petunjuk:</strong></p>
                        <ul class="text-sm text-blue-700 mt-2 space-y-1">
                            <li>‚Ä¢ Klik ‚ûï untuk menambah siswa baru ke kelas tertentu</li>
                            <li>‚Ä¢ Klik ‚úèÔ∏è untuk mengedit nama atau NIS siswa</li>
                            <li>‚Ä¢ Data akan tersimpan secara otomatis di browser</li>
                        </ul>
                    </div>
                </div>
            `;
            document.getElementById('adminContent').innerHTML = content;
        }

        function showUserManagement() {
            const content = `
                <div class="bg-white rounded-lg shadow-lg p-6 border-2 border-purple-200">
                    <h3 class="text-xl font-bold mb-4 text-purple-800">üë• Kelola User Sistem</h3>
                    
                    <!-- Tab Navigation -->
                    <div class="flex space-x-2 mb-6 border-b border-purple-200">
                        <button onclick="showUserTab('admin')" id="tabAdmin" class="px-4 py-2 font-medium text-purple-600 border-b-2 border-purple-600">
                            üîë Admin
                        </button>
                        <button onclick="showUserTab('guru')" id="tabGuru" class="px-4 py-2 font-medium text-gray-600 hover:text-purple-600">
                            üë®‚Äçüè´ Guru
                        </button>
                        <button onclick="showUserTab('wali')" id="tabWali" class="px-4 py-2 font-medium text-gray-600 hover:text-purple-600">
                            üë©‚Äçüè´ Wali Kelas
                        </button>
                    </div>

                    <!-- Tab Content -->
                    <div id="userTabContent">
                        <!-- Content akan diisi oleh JavaScript -->
                    </div>
                </div>
            `;
            document.getElementById('adminContent').innerHTML = content;
            showUserTab('admin'); // Default tab
        }

        function showUserTab(tabType) {
            // Update tab styling
            document.querySelectorAll('[id^="tab"]').forEach(tab => {
                tab.className = 'px-4 py-2 font-medium text-gray-600 hover:text-purple-600';
            });
            document.getElementById('tab' + tabType.charAt(0).toUpperCase() + tabType.slice(1)).className = 'px-4 py-2 font-medium text-purple-600 border-b-2 border-purple-600';

            let content = '';
            
            if (tabType === 'admin') {
                content = `
                    <div class="space-y-4">
                        <div class="p-4 bg-red-50 border-l-4 border-red-400">
                            <h4 class="font-bold text-red-800 mb-2">üîë Administrator Sekolah</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-red-800 font-medium mb-2">Username</label>
                                    <input type="text" id="adminUsername" value="${userData.admin.username}" class="w-full px-3 py-2 border-2 border-red-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-400 focus:border-red-400">
                                </div>
                                <div>
                                    <label class="block text-red-800 font-medium mb-2">Password</label>
                                    <div class="relative">
                                        <input type="password" id="adminPassword" value="${userData.admin.password}" class="w-full px-3 py-2 border-2 border-red-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-400 focus:border-red-400 pr-10">
                                        <button type="button" onclick="togglePasswordVisibility('adminPassword')" class="absolute right-3 top-2.5 text-red-600 hover:text-red-800">
                                            üëÅÔ∏è
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <button onclick="updateAdminCredentials()" class="mt-4 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg border-2 border-red-400">
                                üíæ Update Admin
                            </button>
                        </div>
                    </div>
                `;
            } else if (tabType === 'guru') {
                content = `
                    <div class="space-y-4">
                        <div class="p-4 bg-blue-50 border-l-4 border-blue-400">
                            <h4 class="font-bold text-blue-800 mb-3">üë®‚Äçüè´ Daftar Guru Kelas</h4>
                            <div class="space-y-3">
                                ${Object.keys(userData.guru).map(username => {
                                    const guru = userData.guru[username];
                                    return `
                                        <div class="bg-white p-3 rounded border border-blue-200">
                                            <div class="flex justify-between items-center mb-2">
                                                <h5 class="font-medium text-blue-800">${guru.name}</h5>
                                                <span class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded">Kelas ${guru.kelas}</span>
                                            </div>
                                            <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                                                <div>
                                                    <label class="block text-blue-700 text-sm mb-1">Username</label>
                                                    <input type="text" id="guru_${username}_username" value="${guru.username}" class="w-full px-2 py-1 text-sm border border-blue-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-400">
                                                </div>
                                                <div>
                                                    <label class="block text-blue-700 text-sm mb-1">Password</label>
                                                    <div class="relative">
                                                        <input type="password" id="guru_${username}_password" value="${guru.password}" class="w-full px-2 py-1 text-sm border border-blue-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-400 pr-8">
                                                        <button type="button" onclick="togglePasswordVisibility('guru_${username}_password')" class="absolute right-2 top-1 text-blue-600 hover:text-blue-800 text-xs">
                                                            üëÅÔ∏è
                                                        </button>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label class="block text-blue-700 text-sm mb-1">Nama Lengkap</label>
                                                    <input type="text" id="guru_${username}_name" value="${guru.name}" placeholder="Contoh: Ibu Siti, S.Pd" class="w-full px-2 py-1 text-sm border border-blue-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-400">
                                                </div>
                                            </div>
                                            <button onclick="updateGuruCredentials('${username}')" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                                                üíæ Update
                                            </button>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            } else if (tabType === 'wali') {
                const waliList = Object.keys(userData.waliKelas);
                content = `
                    <div class="space-y-4">
                        <div class="p-4 bg-green-50 border-l-4 border-green-400">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-bold text-green-800">üë©‚Äçüè´ Wali Kelas</h4>
                                <button onclick="showAddWaliForm()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm border border-green-400">
                                    ‚ûï Tambah Wali Kelas
                                </button>
                            </div>
                            
                            <!-- Form Tambah Wali (Hidden by default) -->
                            <div id="addWaliForm" class="hidden mb-4 p-3 bg-green-100 border border-green-300 rounded">
                                <h5 class="font-medium text-green-800 mb-2">Tambah Wali Kelas Baru</h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-green-700 text-sm mb-1">Username</label>
                                        <input type="text" id="newWaliUsername" placeholder="wali1" class="w-full px-3 py-2 text-sm border border-green-300 rounded focus:outline-none focus:ring-1 focus:ring-green-400">
                                    </div>
                                    <div>
                                        <label class="block text-green-700 text-sm mb-1">Password</label>
                                        <input type="password" id="newWaliPassword" placeholder="password123" class="w-full px-3 py-2 text-sm border border-green-300 rounded focus:outline-none focus:ring-1 focus:ring-green-400">
                                    </div>
                                    <div>
                                        <label class="block text-green-700 text-sm mb-1">Kelas</label>
                                        <select id="newWaliKelas" class="w-full px-3 py-2 text-sm border border-green-300 rounded focus:outline-none focus:ring-1 focus:ring-green-400">
                                            <option value="">Pilih Kelas</option>
                                            <option value="1">Kelas 1</option>
                                            <option value="2">Kelas 2</option>
                                            <option value="3">Kelas 3</option>
                                            <option value="4">Kelas 4</option>
                                            <option value="5">Kelas 5</option>
                                            <option value="6">Kelas 6</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-green-700 text-sm mb-1">Nama Lengkap</label>
                                        <input type="text" id="newWaliName" placeholder="Contoh: Ibu Siti Nurhaliza, S.Pd" class="w-full px-3 py-2 text-sm border border-green-300 rounded focus:outline-none focus:ring-1 focus:ring-green-400">
                                    </div>
                                </div>
                                <div class="mt-2 flex space-x-2">
                                    <button onclick="addWaliKelas()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                                        ‚úÖ Simpan
                                    </button>
                                    <button onclick="hideAddWaliForm()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                                        ‚ùå Batal
                                    </button>
                                </div>
                            </div>

                            ${waliList.length > 0 ? `
                                <div class="space-y-3">
                                    ${waliList.map(username => {
                                        const wali = userData.waliKelas[username];
                                        return `
                                            <div class="bg-white p-3 rounded border border-green-200">
                                                <div class="flex justify-between items-center mb-2">
                                                    <h5 class="font-medium text-green-800">${wali.name}</h5>
                                                    <div class="flex items-center space-x-2">
                                                        <span class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded">Kelas ${wali.kelas}</span>
                                                        <button onclick="deleteWaliKelas('${username}')" class="text-red-600 hover:text-red-800 text-sm" title="Hapus Wali Kelas">
                                                            üóëÔ∏è
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                                                    <div>
                                                        <label class="block text-green-700 text-sm mb-1">Username</label>
                                                        <input type="text" id="wali_${username}_username" value="${wali.username}" class="w-full px-2 py-1 text-sm border border-green-300 rounded focus:outline-none focus:ring-1 focus:ring-green-400">
                                                    </div>
                                                    <div>
                                                        <label class="block text-green-700 text-sm mb-1">Password</label>
                                                        <div class="relative">
                                                            <input type="password" id="wali_${username}_password" value="${wali.password}" class="w-full px-2 py-1 text-sm border border-green-300 rounded focus:outline-none focus:ring-1 focus:ring-green-400 pr-8">
                                                            <button type="button" onclick="togglePasswordVisibility('wali_${username}_password')" class="absolute right-2 top-1 text-green-600 hover:text-green-800 text-xs">
                                                                üëÅÔ∏è
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label class="block text-green-700 text-sm mb-1">Nama Lengkap</label>
                                                        <input type="text" id="wali_${username}_name" value="${wali.name}" class="w-full px-2 py-1 text-sm border border-green-300 rounded focus:outline-none focus:ring-1 focus:ring-green-400">
                                                    </div>
                                                </div>
                                                <button onclick="updateWaliCredentials('${username}')" class="mt-2 bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                                                    üíæ Update
                                                </button>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : `
                                <div class="text-center py-8 text-green-600">
                                    <p class="text-lg">üë©‚Äçüè´</p>
                                    <p>Belum ada wali kelas yang ditambahkan</p>
                                    <p class="text-sm text-green-500 mt-2">Klik "Tambah Wali Kelas" untuk menambah wali kelas baru</p>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }

            document.getElementById('userTabContent').innerHTML = content;
        }

        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'üôà';
            } else {
                input.type = 'password';
                button.textContent = 'üëÅÔ∏è';
            }
        }

        function updateAdminCredentials() {
            const newUsername = document.getElementById('adminUsername').value.trim();
            const newPassword = document.getElementById('adminPassword').value.trim();

            if (!newUsername || !newPassword) {
                alert('‚ùå Username dan password tidak boleh kosong!');
                return;
            }

            if (newPassword.length < 6) {
                alert('‚ùå Password minimal 6 karakter!');
                return;
            }

            userData.admin.username = newUsername;
            userData.admin.password = newPassword;
            
            saveUserData();
            alert('‚úÖ Kredensial admin berhasil diperbarui!\n\nGunakan username dan password baru untuk login selanjutnya.');
        }

        function updateGuruCredentials(oldUsername) {
            const newUsername = document.getElementById(`guru_${oldUsername}_username`).value.trim();
            const newPassword = document.getElementById(`guru_${oldUsername}_password`).value.trim();
            const newName = document.getElementById(`guru_${oldUsername}_name`).value.trim();

            if (!newUsername || !newPassword || !newName) {
                alert('‚ùå Username, password, dan nama tidak boleh kosong!');
                return;
            }

            if (newPassword.length < 6) {
                alert('‚ùå Password minimal 6 karakter!');
                return;
            }

            // Cek apakah username baru sudah digunakan (kecuali untuk user yang sama)
            if (newUsername !== oldUsername) {
                if (userData.guru[newUsername] || userData.admin.username === newUsername) {
                    alert('‚ùå Username sudah digunakan! Silakan pilih username lain.');
                    return;
                }
            }

            // Update data
            const guruData = userData.guru[oldUsername];
            const oldName = guruData.name;
            guruData.username = newUsername;
            guruData.password = newPassword;
            guruData.name = newName;

            // Jika username berubah, pindahkan ke key baru
            if (newUsername !== oldUsername) {
                userData.guru[newUsername] = guruData;
                delete userData.guru[oldUsername];
            }

            saveUserData();
            alert(`‚úÖ Data guru kelas ${guruData.kelas} berhasil diperbarui!\n\nüìù Perubahan:\n‚Ä¢ Username: ${oldUsername} ‚Üí ${newUsername}\n‚Ä¢ Nama: ${oldName} ‚Üí ${newName}\n‚Ä¢ Password: Diperbarui`);
            
            // Refresh tampilan
            showUserTab('guru');
        }

        function showAddWaliForm() {
            document.getElementById('addWaliForm').classList.remove('hidden');
            document.getElementById('newWaliUsername').focus();
        }

        function hideAddWaliForm() {
            document.getElementById('addWaliForm').classList.add('hidden');
            // Reset form
            document.getElementById('newWaliUsername').value = '';
            document.getElementById('newWaliPassword').value = '';
            document.getElementById('newWaliKelas').value = '';
            document.getElementById('newWaliName').value = '';
        }

        function addWaliKelas() {
            const username = document.getElementById('newWaliUsername').value.trim();
            const password = document.getElementById('newWaliPassword').value.trim();
            const kelas = document.getElementById('newWaliKelas').value;
            const name = document.getElementById('newWaliName').value.trim();

            if (!username || !password || !kelas || !name) {
                alert('‚ùå Mohon lengkapi semua data!');
                return;
            }

            if (password.length < 6) {
                alert('‚ùå Password minimal 6 karakter!');
                return;
            }

            // Cek apakah username sudah digunakan
            if (userData.guru[username] || userData.waliKelas[username] || userData.admin.username === username) {
                alert('‚ùå Username sudah digunakan! Silakan pilih username lain.');
                return;
            }

            // Cek apakah kelas sudah memiliki wali kelas
            const existingWali = Object.values(userData.waliKelas).find(wali => wali.kelas === kelas);
            if (existingWali) {
                alert(`‚ùå Kelas ${kelas} sudah memiliki wali kelas (${existingWali.name})!\nSilakan pilih kelas lain atau hapus wali kelas yang ada.`);
                return;
            }

            // Tambah wali kelas baru
            userData.waliKelas[username] = {
                username: username,
                password: password,
                role: 'wali',
                kelas: kelas,
                name: name
            };

            saveUserData();
            alert(`‚úÖ Wali kelas "${name}" untuk Kelas ${kelas} berhasil ditambahkan!`);
            
            hideAddWaliForm();
            showUserTab('wali');
        }

        function updateWaliCredentials(oldUsername) {
            const newUsername = document.getElementById(`wali_${oldUsername}_username`).value.trim();
            const newPassword = document.getElementById(`wali_${oldUsername}_password`).value.trim();
            const newName = document.getElementById(`wali_${oldUsername}_name`).value.trim();

            if (!newUsername || !newPassword || !newName) {
                alert('‚ùå Username, password, dan nama tidak boleh kosong!');
                return;
            }

            if (newPassword.length < 6) {
                alert('‚ùå Password minimal 6 karakter!');
                return;
            }

            // Cek apakah username baru sudah digunakan (kecuali untuk user yang sama)
            if (newUsername !== oldUsername) {
                if (userData.guru[newUsername] || userData.admin.username === newUsername) {
                    alert('‚ùå Username sudah digunakan! Silakan pilih username lain.');
                    return;
                }
            }

            // Update data
            const waliData = userData.waliKelas[oldUsername];
            waliData.username = newUsername;
            waliData.password = newPassword;
            waliData.name = newName;

            // Jika username berubah, pindahkan ke key baru
            if (newUsername !== oldUsername) {
                userData.waliKelas[newUsername] = waliData;
                delete userData.waliKelas[oldUsername];
            }

            saveUserData();
            alert(`‚úÖ Data wali kelas ${waliData.kelas} berhasil diperbarui!\n\nüìù Perubahan:\n‚Ä¢ Username: ${oldUsername} ‚Üí ${newUsername}\n‚Ä¢ Nama: ${newName}\n‚Ä¢ Password: Diperbarui`);
            
            // Refresh tampilan
            showUserTab('wali');
        }

        function deleteWaliKelas(username) {
            const wali = userData.waliKelas[username];
            
            if (confirm(`üóëÔ∏è Hapus Wali Kelas?\n\nApakah Anda yakin ingin menghapus:\n‚Ä¢ Nama: ${wali.name}\n‚Ä¢ Username: ${wali.username}\n‚Ä¢ Kelas: ${wali.kelas}\n\nTindakan ini tidak dapat dibatalkan!`)) {
                delete userData.waliKelas[username];
                saveUserData();
                alert(`‚úÖ Wali kelas "${wali.name}" berhasil dihapus!`);
                showUserTab('wali');
            }
        }

        function saveUserData() {
            try {
                localStorage.setItem('userData', JSON.stringify(userData));
                console.log('Data user berhasil disimpan');
                
                // Sinkronkan ke Google Sheets
                syncSystemDataToServer();
            } catch (error) {
                console.error('Error saving user data:', error);
                alert('‚ùå Gagal menyimpan data user. Storage mungkin penuh.');
            }
        }

        // Fungsi untuk sinkronisasi data sistem ke server
        function syncSystemDataToServer() {
            // Simpan data sistem ke sheet "SystemData" di Google Sheets
            const systemData = {
                action: 'saveSystemData',
                userData: userData,
                siswaData: siswaData,
                timestamp: new Date().toISOString()
            };

            fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(systemData)
            })
            .then(() => {
                console.log('‚úÖ Data sistem berhasil disinkron ke server');
                
                // Tampilkan notifikasi sukses
                showSyncNotification('‚úÖ Data sistem tersinkron ke Google Sheets');
            })
            .catch(error => {
                console.error('‚ùå Gagal sinkron data sistem:', error);
                showSyncNotification('‚ö†Ô∏è Gagal sinkron ke server, data tersimpan lokal');
            });
        }

        // Fungsi untuk memuat data sistem dari server
        function loadSystemDataFromServer() {
            return new Promise((resolve) => {
                // Coba ambil data dari sheet "SystemData"
                fetch(API_URL + '?action=getSystemData&t=' + Date.now())
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(serverData => {
                    let dataLoaded = false;
                    
                    if (serverData && serverData.userData) {
                        // Merge data user dari server dengan prioritas server
                        const mergedUserData = { ...userData };
                        
                        // Update admin data jika ada
                        if (serverData.userData.admin) {
                            mergedUserData.admin = { ...mergedUserData.admin, ...serverData.userData.admin };
                        }
                        
                        // Update guru data jika ada
                        if (serverData.userData.guru) {
                            mergedUserData.guru = { ...mergedUserData.guru, ...serverData.userData.guru };
                        }
                        
                        // Update wali kelas data jika ada
                        if (serverData.userData.waliKelas) {
                            mergedUserData.waliKelas = { ...mergedUserData.waliKelas, ...serverData.userData.waliKelas };
                        }
                        
                        userData = mergedUserData;
                        localStorage.setItem('userData', JSON.stringify(userData));
                        console.log('‚úÖ Data user dimuat dari server');
                        dataLoaded = true;
                    }
                    
                    if (serverData && serverData.siswaData) {
                        // Merge data siswa dari server
                        Object.keys(serverData.siswaData).forEach(kelas => {
                            if (serverData.siswaData[kelas] && Array.isArray(serverData.siswaData[kelas])) {
                                siswaData[kelas] = serverData.siswaData[kelas];
                            }
                        });
                        localStorage.setItem('siswaData', JSON.stringify(siswaData));
                        console.log('‚úÖ Data siswa dimuat dari server');
                        dataLoaded = true;
                    }
                    
                    resolve(dataLoaded);
                })
                .catch(error => {
                    console.error('Error loading system data from server:', error);
                    // Jika gagal, coba dengan metode fallback
                    resolve(false);
                });
            });
        }

        // Fungsi untuk menampilkan notifikasi sinkronisasi
        function showSyncNotification(message) {
            // Hapus notifikasi lama jika ada
            const oldNotif = document.getElementById('syncNotification');
            if (oldNotif) {
                oldNotif.remove();
            }
            
            // Buat notifikasi baru
            const notification = document.createElement('div');
            notification.id = 'syncNotification';
            notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg z-50 shadow-lg';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Hapus notifikasi setelah 3 detik
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        function loadUserData() {
            try {
                const savedData = localStorage.getItem('userData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    // Merge dengan data default
                    userData = { ...userData, ...parsedData };
                    console.log('Data user berhasil dimuat dari localStorage');
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        function showSystemInfo() {
            const totalGuru = Object.keys(userData.guru).length;
            const localAbsensi = getLocalAbsensiData().length;
            const totalSiswa = Object.values(siswaData).reduce((total, kelas) => total + kelas.length, 0);

            const content = `
                <div class="bg-white rounded-lg shadow-lg p-6 border-2 border-gray-200">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">‚ÑπÔ∏è Informasi Sistem</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <div class="text-2xl font-bold text-blue-600">${totalSiswa}</div>
                            <div class="text-sm text-blue-700">Total Siswa</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <div class="text-2xl font-bold text-green-600">${totalGuru}</div>
                            <div class="text-sm text-green-700">Guru Kelas</div>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                            <div class="text-2xl font-bold text-yellow-600">${localAbsensi}</div>
                            <div class="text-sm text-yellow-700">Data Absensi</div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="p-4 bg-blue-50 border-l-4 border-blue-400">
                            <h4 class="font-bold text-blue-800 mb-2">üë• Pengguna Sistem</h4>
                            <div class="text-sm text-blue-700 space-y-1">
                                <p><strong>Administrator:</strong> ${userData.admin.name} (${userData.admin.username})</p>
                                <p><strong>Guru Kelas:</strong> ${totalGuru} akun</p>
                            </div>
                        </div>

                        <div class="p-4 bg-green-50 border-l-4 border-green-400">
                            <h4 class="font-bold text-green-800 mb-2">üìä Data Siswa per Kelas</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm text-green-700">
                                ${Object.keys(siswaData).map(kelas => 
                                    `<div>Kelas ${kelas}: ${siswaData[kelas].length} siswa</div>`
                                ).join('')}
                            </div>
                        </div>

                        <div class="p-4 bg-yellow-50 border-l-4 border-yellow-400">
                            <h4 class="font-bold text-yellow-800 mb-2">üîß Pengaturan Teknis</h4>
                            <div class="text-sm text-yellow-700 space-y-1">
                                <p><strong>Google Apps Script URL:</strong> <span class="font-mono text-xs">${API_URL}</span></p>
                                <p><strong>Data Tersimpan Lokal:</strong> ${localAbsensi} record absensi</p>
                                <p><strong>Status Sistem:</strong> <span class="text-green-600 font-medium">Aktif</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('adminContent').innerHTML = content;
        }

        function showSettings() {
            const content = `
                <div class="bg-white rounded-lg shadow-lg p-6 border-2 border-blue-200">
                    <h3 class="text-xl font-bold mb-4 text-blue-800">‚öôÔ∏è Pengaturan Sistem</h3>
                    
                    <div class="space-y-4">
                        <div class="p-4 bg-yellow-50 border-l-4 border-yellow-400">
                            <h4 class="font-bold text-yellow-800 mb-2">Jika Data Tidak Masuk ke Google Sheets:</h4>
                            <ol class="list-decimal list-inside text-sm text-yellow-700 space-y-1">
                                <li>Pastikan Google Apps Script sudah di-<strong>deploy</strong> sebagai Web App</li>
                                <li>Set permission ke "Anyone" atau "Anyone with the link"</li>
                                <li>Pastikan Spreadsheet ID benar: <code class="bg-yellow-200 px-1 rounded">1aPRVaYxUrvK6acOD6o-ZzvQzWpwW5ujtoCMIbh-X5cE</code></li>
                                <li>Sheet name harus: <strong>"Absensi"</strong></li>
                            </ol>
                        </div>

                        <div class="p-4 bg-red-50 border-l-4 border-red-400">
                            <h4 class="font-bold text-red-800 mb-2">Jika Data Tidak Bisa Dimuat:</h4>
                            <ol class="list-decimal list-inside text-sm text-red-700 space-y-1">
                                <li>Cek apakah URL Apps Script sudah benar</li>
                                <li>Pastikan fungsi doGet() ada di script</li>
                                <li>Test URL di browser: <a href="${API_URL}" target="_blank" class="underline text-blue-600">Klik untuk test</a></li>
                            </ol>
                        </div>

                        <div class="p-4 bg-green-50 border-l-4 border-green-400">
                            <h4 class="font-bold text-green-800 mb-2">‚úÖ Langkah Setup Google Apps Script:</h4>
                            <ol class="list-decimal list-inside text-sm text-green-700 space-y-1">
                                <li>Buka Google Apps Script ‚Üí New Project</li>
                                <li>Copy-paste code yang diberikan</li>
                                <li>Save project</li>
                                <li>Deploy ‚Üí New Deployment ‚Üí Type: Web App</li>
                                <li>Execute as: Me, Access: Anyone</li>
                                <li>Copy URL dan update di sistem ini</li>
                            </ol>
                        </div>

                        <div class="p-4 bg-blue-50 border-l-4 border-blue-400">
                            <h4 class="font-bold text-blue-800 mb-2">üõ†Ô∏è Tools Pengaturan:</h4>
                            <div class="flex flex-wrap gap-2 mt-3">
                                <button onclick="testConnection()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                                    Test Koneksi
                                </button>
                                <button onclick="manualSyncSystemData()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg text-sm">
                                    üîÑ Sinkron Data Sistem
                                </button>
                                <button onclick="testSubmit()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm">
                                    Test Submit Data
                                </button>
                                <button onclick="clearSavedData()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg text-sm">
                                    Hapus Data Tersimpan
                                </button>
                                <button onclick="showSavedData()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm">
                                    Lihat Data Tersimpan
                                </button>
                                <button onclick="clearAbsensiData()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm">
                                    Hapus Data Absensi
                                </button>
                            </div>
                        </div>

                        <div class="p-4 bg-gray-50 border-l-4 border-gray-400">
                            <h4 class="font-bold text-gray-800 mb-2">‚ÑπÔ∏è Informasi Sistem:</h4>
                            <div class="text-sm text-gray-700 space-y-1">
                                <p><strong>URL Google Apps Script:</strong> <code class="bg-gray-200 px-1 rounded text-xs">${API_URL}</code></p>
                                <p><strong>Data Lokal:</strong> <span id="localDataCount">Memuat...</span> record tersimpan</p>
                                <p><strong>Status:</strong> <span class="text-green-600">Sistem Aktif</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('adminContent').innerHTML = content;
            
            // Update jumlah data lokal
            setTimeout(() => {
                const localData = getLocalAbsensiData();
                document.getElementById('localDataCount').textContent = localData.length;
            }, 100);
        }

        function testConnection() {
            alert('Testing koneksi ke Google Sheets...');
            fetch(API_URL + '?test=1')
            .then(response => response.json())
            .then(data => {
                alert('‚úÖ Koneksi berhasil! Data ditemukan: ' + (data.length || 0) + ' record');
            })
            .catch(error => {
                alert('‚ùå Koneksi gagal: ' + error.message + '\n\nPastikan Google Apps Script sudah di-deploy dengan benar.');
            });
        }

        function testSubmit() {
            const testData = {
                nis: 'TEST001',
                nama: 'Test Siswa',
                kelas: 'Test Kelas',
                keterangan: 'Test'
            };
            
            alert('Mengirim data test ke Google Sheets...');
            sendToGoogleSheets(testData);
        }

        function clearSavedData() {
            if (confirm('Apakah Anda yakin ingin menghapus semua data form yang tersimpan?')) {
                localStorage.removeItem('absensiSystemState');
                alert('‚úÖ Data tersimpan berhasil dihapus!');
                
                // Reset form yang sedang aktif
                if (document.getElementById('siswaSelect')) {
                    document.getElementById('siswaSelect').value = '';
                    document.getElementById('keterangan').value = 'Hadir';
                }
                if (document.getElementById('siswaSelectGuru')) {
                    document.getElementById('siswaSelectGuru').value = '';
                    document.getElementById('keteranganGuru').value = 'Hadir';
                }
            }
        }

        function clearAbsensiData() {
            const localData = getLocalAbsensiData();
            if (localData.length === 0) {
                alert('üì≠ Tidak ada data absensi yang tersimpan.');
                return;
            }
            
            if (confirm(`Apakah Anda yakin ingin menghapus semua ${localData.length} data absensi yang tersimpan?\n\nPeringatan: Data yang belum tersinkron ke Google Sheets akan hilang permanen!`)) {
                clearLocalAbsensiData();
                alert('‚úÖ Semua data absensi berhasil dihapus!');
                
                // Refresh tabel jika sedang ditampilkan
                if (document.getElementById('absensiTable')) {
                    document.getElementById('absensiTable').innerHTML = '<p class="text-gray-600">Tidak ada data absensi</p>';
                }
                if (document.getElementById('absensiTableGuest')) {
                    document.getElementById('absensiTableGuest').innerHTML = '<p class="text-gray-600">Tidak ada data absensi</p>';
                }
            }
        }

        // Fungsi untuk sinkronisasi manual data sistem
        function manualSyncSystemData() {
            const loadingMsg = document.createElement('div');
            loadingMsg.id = 'syncLoadingMsg';
            loadingMsg.className = 'fixed top-4 right-4 bg-orange-600 text-white px-4 py-2 rounded-lg z-50 shadow-lg';
            loadingMsg.innerHTML = 'üîÑ Menyinkronkan data sistem...<br><small>Mohon tunggu...</small>';
            document.body.appendChild(loadingMsg);
            
            // Step 1: Upload data sistem ke server
            console.log('üì§ Mengirim data sistem ke Google Sheets...');
            
            const systemData = {
                action: 'saveSystemData',
                userData: userData,
                siswaData: siswaData,
                timestamp: new Date().toISOString()
            };

            fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(systemData)
            })
            .then(() => {
                console.log('‚úÖ Data berhasil dikirim ke server');
                
                // Update loading message
                if (loadingMsg) {
                    loadingMsg.innerHTML = 'üì• Mengambil data terbaru...<br><small>Hampir selesai...</small>';
                }
                
                // Step 2: Download data terbaru dari server
                setTimeout(() => {
                    loadSystemDataFromServer().then(success => {
                        if (loadingMsg) {
                            loadingMsg.remove();
                        }
                        
                        if (success) {
                            showSyncNotification('‚úÖ Sinkronisasi berhasil! Data tersinkron antar perangkat');
                            
                            // Refresh tampilan jika sedang di user management
                            if (document.getElementById('userTabContent')) {
                                const activeTab = document.querySelector('[id^="tab"].border-b-2');
                                if (activeTab) {
                                    const tabType = activeTab.id.replace('tab', '').toLowerCase();
                                    showUserTab(tabType);
                                }
                            }
                            
                            // Tampilkan dialog sukses dengan detail
                            setTimeout(() => {
                                alert('üéâ SINKRONISASI BERHASIL!\n\n‚úÖ Data yang tersinkron:\n‚Ä¢ Nama guru dan wali kelas\n‚Ä¢ Data siswa per kelas\n‚Ä¢ Pengaturan sistem\n\nüì± Sekarang data akan sama di semua perangkat!\n\nCoba login di perangkat lain untuk memastikan.');
                            }, 500);
                            
                        } else {
                            showSyncNotification('‚ö†Ô∏è Upload berhasil, namun gagal ambil data terbaru');
                            
                            setTimeout(() => {
                                alert('‚ö†Ô∏è SINKRONISASI SEBAGIAN BERHASIL\n\n‚úÖ Data berhasil dikirim ke Google Sheets\n‚ùå Gagal mengambil data terbaru dari server\n\nüí° Solusi:\n‚Ä¢ Coba refresh halaman\n‚Ä¢ Atau login ulang\n‚Ä¢ Periksa koneksi internet');
                            }, 500);
                        }
                    });
                }, 2000);
            })
            .catch(error => {
                console.error('‚ùå Gagal mengirim data:', error);
                
                if (loadingMsg) {
                    loadingMsg.remove();
                }
                
                showSyncNotification('‚ùå Gagal sinkronisasi - periksa koneksi');
                
                setTimeout(() => {
                    alert('‚ùå SINKRONISASI GAGAL\n\nüîç Kemungkinan penyebab:\n‚Ä¢ Koneksi internet bermasalah\n‚Ä¢ Google Apps Script belum di-update\n‚Ä¢ URL Apps Script tidak valid\n\nüí° Solusi:\n‚Ä¢ Periksa koneksi internet\n‚Ä¢ Pastikan kode Apps Script sudah diperbarui\n‚Ä¢ Test koneksi di menu Pengaturan');
                }, 500);
            });
        }

        function showSavedData() {
            const savedState = localStorage.getItem('absensiSystemState');
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    const timestamp = new Date(state.timestamp).toLocaleString('id-ID');
                    
                    let message = `üìä Data Tersimpan (${timestamp}):\n\n`;
                    
                    if (state.formData.adminSiswa) {
                        message += `üîπ Form Admin:\n`;
                        message += `   Siswa: ${state.formData.adminSiswa || 'Belum dipilih'}\n`;
                        message += `   Keterangan: ${state.formData.adminKeterangan}\n\n`;
                    }
                    
                    if (state.formData.guruSiswa) {
                        message += `üîπ Form Guru:\n`;
                        message += `   Siswa: ${state.formData.guruSiswa}\n`;
                        message += `   Keterangan: ${state.formData.guruKeterangan}\n`;
                    }
                    
                    if (!state.formData.adminSiswa && !state.formData.guruSiswa) {
                        message += 'Tidak ada data form yang tersimpan.';
                    }
                    
                    alert(message);
                } catch (error) {
                    alert('‚ùå Error membaca data tersimpan: ' + error.message);
                }
            } else {
                alert('üì≠ Tidak ada data yang tersimpan.');
            }
        }

        // Fungsi untuk menyimpan state saat ini
        function saveCurrentState() {
            const state = {
                lastView: getCurrentView(),
                formData: getFormData(),
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('absensiSystemState', JSON.stringify(state));
        }

        // Fungsi untuk mendapatkan view yang sedang aktif
        function getCurrentView() {
            if (!document.getElementById('adminDashboard').classList.contains('hidden')) {
                return 'admin';
            } else if (!document.getElementById('guruDashboard').classList.contains('hidden')) {
                return 'guru';
            } else if (!document.getElementById('guestDashboard').classList.contains('hidden')) {
                return 'guest';
            }
            return 'login';
        }

        // Fungsi untuk mengambil data form yang sedang aktif
        function getFormData() {
            const formData = {};
            
            // Simpan data form admin
            if (document.getElementById('siswaSelect')) {
                formData.adminSiswa = document.getElementById('siswaSelect').value;
                formData.adminKeterangan = document.getElementById('keterangan').value;
            }
            
            // Simpan data form guru
            if (document.getElementById('siswaSelectGuru')) {
                formData.guruSiswa = document.getElementById('siswaSelectGuru').value;
                formData.guruKeterangan = document.getElementById('keteranganGuru').value;
            }
            
            return formData;
        }

        // Fungsi untuk memulihkan state
        function restoreState() {
            const savedState = localStorage.getItem('absensiSystemState');
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    
                    // Pulihkan data form setelah delay singkat untuk memastikan DOM sudah siap
                    setTimeout(() => {
                        restoreFormData(state.formData);
                    }, 500);
                    
                    return state;
                } catch (error) {
                    console.error('Error parsing saved state:', error);
                }
            }
            return null;
        }

        // Fungsi untuk memulihkan data form
        function restoreFormData(formData) {
            if (!formData) return;
            
            // Pulihkan form admin
            if (formData.adminSiswa && document.getElementById('siswaSelect')) {
                document.getElementById('siswaSelect').value = formData.adminSiswa;
            }
            if (formData.adminKeterangan && document.getElementById('keterangan')) {
                document.getElementById('keterangan').value = formData.adminKeterangan;
            }
            
            // Pulihkan form guru
            if (formData.guruSiswa && document.getElementById('siswaSelectGuru')) {
                document.getElementById('siswaSelectGuru').value = formData.guruSiswa;
            }
            if (formData.guruKeterangan && document.getElementById('keteranganGuru')) {
                document.getElementById('keteranganGuru').value = formData.guruKeterangan;
            }
        }

        // Auto-save setiap kali ada perubahan form
        function setupAutoSave() {
            // Auto-save untuk form admin
            const adminInputs = ['siswaSelect', 'keterangan'];
            adminInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', saveCurrentState);
                }
            });
            
            // Auto-save untuk form guru
            const guruInputs = ['siswaSelectGuru', 'keteranganGuru'];
            guruInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', saveCurrentState);
                }
            });
        }

        // Auto-save setiap 30 detik
        setInterval(saveCurrentState, 30000);

        // Auto-save saat user meninggalkan halaman
        window.addEventListener('beforeunload', saveCurrentState);

        // Fungsi untuk menyimpan data absensi ke localStorage
        function saveToLocalStorage(data) {
            try {
                let absensiData = JSON.parse(localStorage.getItem('absensiData') || '[]');
                
                // Tambahkan ID unik untuk setiap record
                data.id = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                absensiData.push(data);
                
                // Batasi maksimal 1000 record untuk menghindari localStorage penuh
                if (absensiData.length > 1000) {
                    absensiData = absensiData.slice(-1000);
                }
                
                localStorage.setItem('absensiData', JSON.stringify(absensiData));
                console.log('Data absensi disimpan ke localStorage:', data);
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }

        // Fungsi untuk mengambil data absensi dari localStorage
        function getLocalAbsensiData() {
            try {
                const data = JSON.parse(localStorage.getItem('absensiData') || '[]');
                return data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Urutkan terbaru dulu
            } catch (error) {
                console.error('Error reading from localStorage:', error);
                return [];
            }
        }

        // Fungsi untuk menghapus data absensi lokal
        function clearLocalAbsensiData() {
            try {
                localStorage.removeItem('absensiData');
                console.log('Data absensi lokal berhasil dihapus');
            } catch (error) {
                console.error('Error clearing localStorage:', error);
            }
        }

        // Fungsi untuk menampilkan form tambah siswa
        function showAddStudentForm() {
            document.getElementById('addStudentForm').classList.remove('hidden');
            document.getElementById('addStudentForm').classList.add('fade-in');
            document.getElementById('newNis').focus();
        }

        // Fungsi untuk menyembunyikan form tambah siswa
        function hideAddStudentForm() {
            document.getElementById('addStudentForm').classList.add('hidden');
            // Reset form
            document.getElementById('newNis').value = '';
            document.getElementById('newNama').value = '';
            document.getElementById('newKelas').value = '';
        }

        // Fungsi untuk menambah siswa baru
        function addNewStudent() {
            const nis = document.getElementById('newNis').value.trim();
            const nama = document.getElementById('newNama').value.trim();
            const kelas = document.getElementById('newKelas').value;

            // Validasi input
            if (!nis || !nama || !kelas) {
                alert('‚ùå Mohon lengkapi semua data siswa!');
                return;
            }

            // Cek apakah NIS sudah ada
            const existingNis = Object.values(siswaData).flat().find(siswa => siswa.nis === nis);
            if (existingNis) {
                alert(`‚ùå NIS "${nis}" sudah digunakan oleh siswa lain!\nSilakan gunakan NIS yang berbeda.`);
                return;
            }

            // Tambahkan siswa baru
            const newStudent = { nis: nis, nama: nama };
            siswaData[kelas].push(newStudent);

            // Simpan ke localStorage
            saveSiswaData();

            // Tampilkan pesan sukses
            alert(`‚úÖ Siswa "${nama}" berhasil ditambahkan ke Kelas ${kelas}!`);

            // Reset form dan refresh tampilan
            hideAddStudentForm();
            showManageData();
        }

        // Fungsi untuk mengedit siswa
        function editStudent(kelas, index) {
            const siswa = siswaData[kelas][index];
            
            // Buat dialog edit yang lebih user-friendly
            const editDialog = `
                <div id="editDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-96 max-w-90vw border-2 border-yellow-400">
                        <h3 class="text-xl font-bold mb-4 text-yellow-800">‚úèÔ∏è Edit Data Siswa</h3>
                        
                        <div class="mb-4 p-3 bg-blue-50 rounded border border-blue-200">
                            <p class="text-sm text-blue-700"><strong>Data Saat Ini:</strong></p>
                            <p class="text-sm text-blue-600">Nama: ${siswa.nama}</p>
                            <p class="text-sm text-blue-600">NIS: ${siswa.nis}</p>
                            <p class="text-sm text-blue-600">Kelas: ${kelas}</p>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-yellow-800 font-medium mb-2">NIS Baru</label>
                                <input type="text" id="editNis" value="${siswa.nis}" class="w-full px-3 py-2 border-2 border-yellow-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400">
                            </div>
                            <div>
                                <label class="block text-yellow-800 font-medium mb-2">Nama Baru</label>
                                <input type="text" id="editNama" value="${siswa.nama}" class="w-full px-3 py-2 border-2 border-yellow-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400">
                            </div>
                        </div>
                        
                        <div class="mt-6 flex space-x-2">
                            <button onclick="saveEditStudent('${kelas}', ${index})" class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white py-2 px-4 rounded-lg font-medium border-2 border-yellow-400">
                                ‚úÖ Simpan Perubahan
                            </button>
                            <button onclick="closeEditDialog()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg font-medium border-2 border-gray-400">
                                ‚ùå Batal
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Tambahkan dialog ke body
            document.body.insertAdjacentHTML('beforeend', editDialog);
            
            // Focus ke input pertama
            setTimeout(() => {
                document.getElementById('editNis').focus();
                document.getElementById('editNis').select();
            }, 100);
        }

        // Fungsi untuk menutup dialog edit
        function closeEditDialog() {
            const dialog = document.getElementById('editDialog');
            if (dialog) {
                dialog.remove();
            }
        }

        // Fungsi untuk menyimpan hasil edit siswa
        function saveEditStudent(kelas, index) {
            const newNis = document.getElementById('editNis').value.trim();
            const newNama = document.getElementById('editNama').value.trim();
            const oldSiswa = siswaData[kelas][index];
            
            // Validasi input
            if (!newNis) {
                alert('‚ùå NIS tidak boleh kosong!');
                document.getElementById('editNis').focus();
                return;
            }
            
            if (!newNama) {
                alert('‚ùå Nama tidak boleh kosong!');
                document.getElementById('editNama').focus();
                return;
            }

            // Cek apakah NIS baru sudah digunakan (kecuali untuk siswa yang sama)
            let nisExists = false;
            for (let kelasKey in siswaData) {
                for (let i = 0; i < siswaData[kelasKey].length; i++) {
                    if (siswaData[kelasKey][i].nis === newNis && !(kelasKey === kelas && i == index)) {
                        nisExists = true;
                        break;
                    }
                }
                if (nisExists) break;
            }
            
            if (nisExists) {
                alert(`‚ùå NIS "${newNis}" sudah digunakan oleh siswa lain!\nSilakan gunakan NIS yang berbeda.`);
                document.getElementById('editNis').focus();
                document.getElementById('editNis').select();
                return;
            }

            // Update data siswa
            siswaData[kelas][index] = {
                nis: newNis,
                nama: newNama
            };

            // Simpan ke localStorage
            saveSiswaData();

            // Tutup dialog
            closeEditDialog();

            // Tampilkan pesan sukses
            alert(`‚úÖ Data siswa berhasil diperbarui!\n\nüìù Perubahan:\n‚Ä¢ NIS: ${oldSiswa.nis} ‚Üí ${newNis}\n‚Ä¢ Nama: ${oldSiswa.nama} ‚Üí ${newNama}\n‚Ä¢ Kelas: ${kelas}`);

            // Refresh tampilan
            showManageData();
        }

        // Fungsi untuk menghapus siswa
        function deleteStudent(kelas, index) {
            const siswa = siswaData[kelas][index];
            
            // Konfirmasi penghapusan dengan informasi lengkap
            const confirmMessage = `üóëÔ∏è HAPUS SISWA\n\nApakah Anda yakin ingin menghapus siswa ini?\n\nüìã Detail Siswa:\n‚Ä¢ Nama: ${siswa.nama}\n‚Ä¢ NIS: ${siswa.nis}\n‚Ä¢ Kelas: ${kelas}\n\n‚ö†Ô∏è PERINGATAN:\nTindakan ini tidak dapat dibatalkan!\nSemua data absensi siswa ini akan tetap ada, namun siswa tidak akan muncul dalam daftar lagi.\n\nKlik OK untuk menghapus, atau Cancel untuk membatalkan.`;
            
            if (confirm(confirmMessage)) {
                // Hapus siswa dari array
                siswaData[kelas].splice(index, 1);
                
                // Simpan perubahan ke localStorage
                saveSiswaData();
                
                // Tampilkan pesan sukses
                alert(`‚úÖ BERHASIL DIHAPUS\n\nSiswa "${siswa.nama}" (NIS: ${siswa.nis}) telah dihapus dari Kelas ${kelas}.\n\nData absensi siswa ini masih tersimpan dalam sistem.`);
                
                // Refresh tampilan dengan memanggil ulang showManageData
                showManageData();
            }
        }

        // Fungsi untuk menyimpan data siswa ke localStorage
        function saveSiswaData() {
            try {
                localStorage.setItem('siswaData', JSON.stringify(siswaData));
                console.log('Data siswa berhasil disimpan ke localStorage');
            } catch (error) {
                console.error('Error saving siswa data:', error);
                alert('‚ùå Gagal menyimpan data siswa. Storage mungkin penuh.');
            }
        }

        // Fungsi untuk memuat data siswa dari localStorage
        function loadSiswaData() {
            try {
                const savedData = localStorage.getItem('siswaData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    // Merge dengan data default, prioritaskan data tersimpan
                    Object.keys(parsedData).forEach(kelas => {
                        if (parsedData[kelas] && Array.isArray(parsedData[kelas])) {
                            siswaData[kelas] = parsedData[kelas];
                        }
                    });
                    console.log('Data siswa berhasil dimuat dari localStorage');
                }
            } catch (error) {
                console.error('Error loading siswa data:', error);
            }
        }

        // Fungsi untuk filter data absensi
        function filterAbsensiData() {
            const filterTanggal = document.getElementById('filterTanggal').value;
            const filterKelas = document.getElementById('filterKelas').value;
            const filterStatus = document.getElementById('filterStatus').value;

            if (!filterTanggal && !filterKelas && !filterStatus) {
                alert('Mohon pilih minimal satu filter untuk mencari data!');
                return;
            }

            // Tampilkan loading
            document.getElementById('absensiTable').innerHTML = '<div class="text-center py-4"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div><p class="mt-2 text-gray-600">Mencari data...</p></div>';

            // Ambil semua data absensi
            let allData = getLocalAbsensiData();

            // Filter data berdasarkan kriteria
            let filteredData = allData.filter(row => {
                let matchTanggal = true;
                let matchKelas = true;
                let matchStatus = true;

                // Filter berdasarkan tanggal
                if (filterTanggal) {
                    const rowDate = new Date(row.timestamp).toISOString().split('T')[0];
                    matchTanggal = rowDate === filterTanggal;
                }

                // Filter berdasarkan kelas
                if (filterKelas) {
                    matchKelas = row.kelas === filterKelas;
                }

                // Filter berdasarkan status
                if (filterStatus) {
                    matchStatus = row.keterangan === filterStatus;
                }

                return matchTanggal && matchKelas && matchStatus;
            });

            // Tampilkan hasil
            displayAbsensiTable(filteredData, 'absensiTable', true);

            // Update info hasil
            const resultsInfo = document.getElementById('resultsInfo');
            const resultsText = document.getElementById('resultsText');
            
            let filterDesc = [];
            if (filterTanggal) filterDesc.push(`Tanggal: ${new Date(filterTanggal).toLocaleDateString('id-ID')}`);
            if (filterKelas) filterDesc.push(`Kelas: ${filterKelas}`);
            if (filterStatus) filterDesc.push(`Status: ${filterStatus}`);

            resultsText.textContent = `Menampilkan ${filteredData.length} data dari ${allData.length} total data. Filter: ${filterDesc.join(', ')}`;
            resultsInfo.classList.remove('hidden');

            // Jika tidak ada data lokal, coba dari server
            if (allData.length === 0) {
                loadAbsensiDataFromServer().then(serverData => {
                    if (serverData && serverData.length > 0) {
                        // Filter data server
                        let filteredServerData = serverData.filter(row => {
                            let matchTanggal = true;
                            let matchKelas = true;
                            let matchStatus = true;

                            if (filterTanggal) {
                                const rowDate = new Date(row.timestamp).toISOString().split('T')[0];
                                matchTanggal = rowDate === filterTanggal;
                            }

                            if (filterKelas) {
                                matchKelas = row.kelas === filterKelas;
                            }

                            if (filterStatus) {
                                matchStatus = row.keterangan === filterStatus;
                            }

                            return matchTanggal && matchKelas && matchStatus;
                        });

                        displayAbsensiTable(filteredServerData, 'absensiTable', true);
                        resultsText.textContent = `Menampilkan ${filteredServerData.length} data dari ${serverData.length} total data (dari server). Filter: ${filterDesc.join(', ')}`;
                    }
                });
            }
        }

        // Fungsi untuk export data absensi
        function exportAbsensiData() {
            const allData = getLocalAbsensiData();
            
            if (allData.length === 0) {
                alert('Tidak ada data absensi untuk di-export!');
                return;
            }

            // Buat CSV content
            let csvContent = "Tanggal,Waktu,NIS,Nama Siswa,Kelas,Keterangan\n";
            
            allData.forEach(row => {
                const dateTime = new Date(row.timestamp);
                const tanggal = dateTime.toLocaleDateString('id-ID');
                const waktu = dateTime.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                
                csvContent += `"${tanggal}","${waktu}","${row.nis}","${row.nama}","${row.kelas}","${row.keterangan}"\n`;
            });

            // Download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Data_Absensi_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            alert(`‚úÖ Data absensi berhasil di-export!\n\nTotal: ${allData.length} record\nFile: Data_Absensi_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // Fungsi untuk menampilkan statistik absensi
        function showAbsensiStats() {
            const allData = getLocalAbsensiData();
            
            if (allData.length === 0) {
                alert('Tidak ada data absensi untuk ditampilkan statistik!');
                return;
            }

            // Hitung statistik per kelas
            const statsByClass = {};
            const statsByDate = {};

            allData.forEach(row => {
                // Statistik per kelas
                if (!statsByClass[row.kelas]) {
                    statsByClass[row.kelas] = { total: 0, hadir: 0, sakit: 0, izin: 0, alpa: 0 };
                }
                statsByClass[row.kelas].total++;
                statsByClass[row.kelas][row.keterangan.toLowerCase()]++;

                // Statistik per tanggal
                const date = new Date(row.timestamp).toLocaleDateString('id-ID');
                if (!statsByDate[date]) {
                    statsByDate[date] = { total: 0, hadir: 0, sakit: 0, izin: 0, alpa: 0 };
                }
                statsByDate[date].total++;
                statsByDate[date][row.keterangan.toLowerCase()]++;
            });

            // Tampilkan statistik
            let statsHTML = `
                <div class="bg-white rounded-lg shadow-lg p-6 border-2 border-purple-200">
                    <h3 class="text-xl font-bold mb-4 text-purple-800">üìà Statistik Absensi</h3>
                    
                    <div class="mb-6">
                        <h4 class="font-bold text-purple-700 mb-3">üìä Statistik Per Kelas</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${Object.keys(statsByClass).map(kelas => {
                                const stats = statsByClass[kelas];
                                const hadirPct = ((stats.hadir / stats.total) * 100).toFixed(1);
                                return `
                                    <div class="p-4 border-2 border-purple-200 rounded-lg bg-purple-50">
                                        <h5 class="font-bold text-purple-800 mb-2">${kelas}</h5>
                                        <div class="text-sm space-y-1">
                                            <div class="flex justify-between">
                                                <span>Total:</span>
                                                <span class="font-bold">${stats.total}</span>
                                            </div>
                                            <div class="flex justify-between text-green-600">
                                                <span>Hadir:</span>
                                                <span class="font-bold">${stats.hadir} (${hadirPct}%)</span>
                                            </div>
                                            <div class="flex justify-between text-yellow-600">
                                                <span>Sakit:</span>
                                                <span class="font-bold">${stats.sakit}</span>
                                            </div>
                                            <div class="flex justify-between text-blue-600">
                                                <span>Izin:</span>
                                                <span class="font-bold">${stats.izin}</span>
                                            </div>
                                            <div class="flex justify-between text-red-600">
                                                <span>Alpa:</span>
                                                <span class="font-bold">${stats.alpa}</span>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <div class="mb-6">
                        <h4 class="font-bold text-purple-700 mb-3">üìÖ Statistik Per Tanggal (5 Terakhir)</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border-2 border-purple-300">
                                <thead class="bg-purple-100">
                                    <tr>
                                        <th class="px-4 py-2 border-b-2 border-purple-300 text-left text-purple-800 font-bold">Tanggal</th>
                                        <th class="px-4 py-2 border-b-2 border-purple-300 text-center text-purple-800 font-bold">Total</th>
                                        <th class="px-4 py-2 border-b-2 border-purple-300 text-center text-purple-800 font-bold">Hadir</th>
                                        <th class="px-4 py-2 border-b-2 border-purple-300 text-center text-purple-800 font-bold">Sakit</th>
                                        <th class="px-4 py-2 border-b-2 border-purple-300 text-center text-purple-800 font-bold">Izin</th>
                                        <th class="px-4 py-2 border-b-2 border-purple-300 text-center text-purple-800 font-bold">Alpa</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.keys(statsByDate).slice(-5).map(date => {
                                        const stats = statsByDate[date];
                                        return `
                                            <tr class="hover:bg-purple-50">
                                                <td class="px-4 py-2 border-b border-purple-200 font-medium">${date}</td>
                                                <td class="px-4 py-2 border-b border-purple-200 text-center font-bold">${stats.total}</td>
                                                <td class="px-4 py-2 border-b border-purple-200 text-center text-green-600 font-bold">${stats.hadir}</td>
                                                <td class="px-4 py-2 border-b border-purple-200 text-center text-yellow-600 font-bold">${stats.sakit}</td>
                                                <td class="px-4 py-2 border-b border-purple-200 text-center text-blue-600 font-bold">${stats.izin}</td>
                                                <td class="px-4 py-2 border-b border-purple-200 text-center text-red-600 font-bold">${stats.alpa}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="flex space-x-2">
                        <button onclick="showDataAbsensi()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg border-2 border-blue-400">
                            ‚Üê Kembali ke Data Absensi
                        </button>
                        <button onclick="exportAbsensiData()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg border-2 border-green-400">
                            üì• Export Data
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('adminContent').innerHTML = statsHTML;
        }

        // Fungsi untuk filter data absensi untuk guest
        function filterAbsensiDataGuest() {
            const filterTanggal = document.getElementById('filterTanggalGuest').value;
            const filterKelas = document.getElementById('filterKelasGuest').value;
            const filterStatus = document.getElementById('filterStatusGuest').value;

            if (!filterTanggal && !filterKelas && !filterStatus) {
                alert('Mohon pilih minimal satu filter untuk mencari data!');
                return;
            }

            // Tampilkan loading
            document.getElementById('absensiTableGuest').innerHTML = '<div class="text-center py-4"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div><p class="mt-2 text-gray-600">Mencari data...</p></div>';

            // Ambil semua data absensi
            let allData = getLocalAbsensiData();

            // Filter data berdasarkan kriteria
            let filteredData = allData.filter(row => {
                let matchTanggal = true;
                let matchKelas = true;
                let matchStatus = true;

                // Filter berdasarkan tanggal
                if (filterTanggal) {
                    const rowDate = new Date(row.timestamp).toISOString().split('T')[0];
                    matchTanggal = rowDate === filterTanggal;
                }

                // Filter berdasarkan kelas
                if (filterKelas) {
                    matchKelas = row.kelas === filterKelas;
                }

                // Filter berdasarkan status
                if (filterStatus) {
                    matchStatus = row.keterangan === filterStatus;
                }

                return matchTanggal && matchKelas && matchStatus;
            });

            // Tampilkan hasil
            displayAbsensiTable(filteredData, 'absensiTableGuest', true);

            // Update info hasil
            const resultsInfo = document.getElementById('resultsInfoGuest');
            const resultsText = document.getElementById('resultsTextGuest');
            
            let filterDesc = [];
            if (filterTanggal) filterDesc.push(`Tanggal: ${new Date(filterTanggal).toLocaleDateString('id-ID')}`);
            if (filterKelas) filterDesc.push(`Kelas: ${filterKelas}`);
            if (filterStatus) filterDesc.push(`Status: ${filterStatus}`);

            resultsText.textContent = `Menampilkan ${filteredData.length} data dari ${allData.length} total data. Filter: ${filterDesc.join(', ')}`;
            resultsInfo.classList.remove('hidden');

            // Jika tidak ada data lokal, coba dari server
            if (allData.length === 0) {
                loadAbsensiDataFromServer().then(serverData => {
                    if (serverData && serverData.length > 0) {
                        // Filter data server
                        let filteredServerData = serverData.filter(row => {
                            let matchTanggal = true;
                            let matchKelas = true;
                            let matchStatus = true;

                            if (filterTanggal) {
                                const rowDate = new Date(row.timestamp).toISOString().split('T')[0];
                                matchTanggal = rowDate === filterTanggal;
                            }

                            if (filterKelas) {
                                matchKelas = row.kelas === filterKelas;
                            }

                            if (filterStatus) {
                                matchStatus = row.keterangan === filterStatus;
                            }

                            return matchTanggal && matchKelas && matchStatus;
                        });

                        displayAbsensiTable(filteredServerData, 'absensiTableGuest', true);
                        resultsText.textContent = `Menampilkan ${filteredServerData.length} data dari ${serverData.length} total data (dari server). Filter: ${filterDesc.join(', ')}`;
                    }
                });
            }
        }

        // Fungsi helper untuk load data dari server
        function loadAbsensiDataFromServer() {
            return new Promise((resolve) => {
                fetch(API_URL + '?t=' + Date.now())
                .then(response => response.json())
                .then(data => resolve(data))
                .catch(error => {
                    console.error('Error loading from server:', error);
                    resolve([]);
                });
            });
        }

        // Fungsi untuk sinkronisasi data otomatis
        function startAutoSync() {
            // Sinkronisasi setiap 30 detik
            setInterval(() => {
                syncPendingData();
                refreshCurrentView();
            }, 30000);
            
            // Sinkronisasi saat online kembali
            window.addEventListener('online', () => {
                console.log('Koneksi kembali, melakukan sinkronisasi...');
                syncPendingData();
                refreshCurrentView();
            });
        }

        // Fungsi untuk sinkronisasi data yang tertunda
        function syncPendingData() {
            const pendingData = getPendingSyncData();
            if (pendingData.length > 0) {
                console.log(`Menyinkronkan ${pendingData.length} data tertunda...`);
                
                pendingData.forEach(data => {
                    sendToGoogleSheets(data, true); // true = silent sync
                });
            }
        }

        // Fungsi untuk mendapatkan data yang belum tersinkron
        function getPendingSyncData() {
            try {
                const pendingData = JSON.parse(localStorage.getItem('pendingSyncData') || '[]');
                return pendingData;
            } catch (error) {
                console.error('Error reading pending sync data:', error);
                return [];
            }
        }

        // Fungsi untuk menyimpan data yang perlu disinkron
        function savePendingSyncData(data) {
            try {
                let pendingData = getPendingSyncData();
                
                // Tambahkan timestamp sync attempt
                data.syncAttempts = (data.syncAttempts || 0) + 1;
                data.lastSyncAttempt = new Date().toISOString();
                
                pendingData.push(data);
                
                // Batasi maksimal 500 data pending
                if (pendingData.length > 500) {
                    pendingData = pendingData.slice(-500);
                }
                
                localStorage.setItem('pendingSyncData', JSON.stringify(pendingData));
                console.log('Data ditambahkan ke antrian sinkronisasi');
            } catch (error) {
                console.error('Error saving pending sync data:', error);
            }
        }

        // Fungsi untuk menghapus data yang sudah tersinkron
        function removeSyncedData(dataId) {
            try {
                let pendingData = getPendingSyncData();
                pendingData = pendingData.filter(data => data.id !== dataId);
                localStorage.setItem('pendingSyncData', JSON.stringify(pendingData));
            } catch (error) {
                console.error('Error removing synced data:', error);
            }
        }

        // Fungsi untuk refresh tampilan saat ini
        function refreshCurrentView() {
            // Hanya refresh jika sedang menampilkan data absensi
            if (document.getElementById('absensiTable') && !document.getElementById('absensiTable').innerHTML.includes('Gunakan filter')) {
                loadAbsensiData();
            }
            if (document.getElementById('absensiTableGuest') && !document.getElementById('absensiTableGuest').innerHTML.includes('Gunakan filter')) {
                loadAbsensiDataGuest();
            }
        }

        // Fungsi untuk backup data ke multiple storage
        function backupDataToMultipleStorage() {
            try {
                const allData = {
                    absensiData: getLocalAbsensiData(),
                    siswaData: siswaData,
                    userData: userData,
                    timestamp: new Date().toISOString()
                };
                
                // Backup ke localStorage dengan key berbeda
                localStorage.setItem('systemBackup', JSON.stringify(allData));
                
                // Backup ke sessionStorage
                sessionStorage.setItem('systemBackup', JSON.stringify(allData));
                
                console.log('Data berhasil dibackup ke multiple storage');
            } catch (error) {
                console.error('Error backing up data:', error);
            }
        }

        // Fungsi untuk restore data dari backup
        function restoreDataFromBackup() {
            try {
                // Coba dari localStorage dulu
                let backupData = localStorage.getItem('systemBackup');
                
                // Jika tidak ada, coba dari sessionStorage
                if (!backupData) {
                    backupData = sessionStorage.getItem('systemBackup');
                }
                
                if (backupData) {
                    const parsedData = JSON.parse(backupData);
                    
                    // Restore data absensi jika kosong
                    const currentAbsensi = getLocalAbsensiData();
                    if (currentAbsensi.length === 0 && parsedData.absensiData && parsedData.absensiData.length > 0) {
                        localStorage.setItem('absensiData', JSON.stringify(parsedData.absensiData));
                        console.log(`Restored ${parsedData.absensiData.length} absensi records from backup`);
                    }
                    
                    // Restore data siswa jika diperlukan
                    if (parsedData.siswaData) {
                        Object.keys(parsedData.siswaData).forEach(kelas => {
                            if (!siswaData[kelas] || siswaData[kelas].length === 0) {
                                siswaData[kelas] = parsedData.siswaData[kelas];
                            }
                        });
                    }
                    
                    // Restore data user jika diperlukan
                    if (parsedData.userData) {
                        userData = { ...userData, ...parsedData.userData };
                    }
                    
                    console.log('Data berhasil direstore dari backup');
                    return true;
                }
            } catch (error) {
                console.error('Error restoring from backup:', error);
            }
            return false;
        }

        // Fungsi untuk monitoring status sinkronisasi
        function showSyncStatus() {
            const pendingCount = getPendingSyncData().length;
            const localCount = getLocalAbsensiData().length;
            
            // Tampilkan status di console
            console.log(`Status Sinkronisasi:
- Data lokal: ${localCount} records
- Data pending sync: ${pendingCount} records
- Status koneksi: ${navigator.onLine ? 'Online' : 'Offline'}`);
            
            // Tampilkan notifikasi jika ada data pending
            if (pendingCount > 0) {
                const statusElement = document.createElement('div');
                statusElement.id = 'syncStatus';
                statusElement.className = 'fixed bottom-20 right-4 bg-yellow-500 text-white px-4 py-2 rounded-lg z-40 text-sm';
                statusElement.innerHTML = `üì§ ${pendingCount} data menunggu sinkronisasi`;
                
                // Hapus status lama jika ada
                const oldStatus = document.getElementById('syncStatus');
                if (oldStatus) {
                    oldStatus.remove();
                }
                
                document.body.appendChild(statusElement);
                
                // Hapus notifikasi setelah 5 detik
                setTimeout(() => {
                    if (document.getElementById('syncStatus')) {
                        document.getElementById('syncStatus').remove();
                    }
                }, 5000);
            }
        }

        // Fungsi untuk membersihkan data absensi harian yang lama
        function cleanupOldAttendanceData() {
            try {
                const today = new Date();
                const keys = Object.keys(localStorage);
                let cleanedCount = 0;
                
                keys.forEach(key => {
                    if (key.startsWith('attendance_')) {
                        const dateStr = key.replace('attendance_', '');
                        const attendanceDate = new Date(dateStr);
                        
                        // Hapus data yang lebih dari 30 hari
                        const daysDiff = (today - attendanceDate) / (1000 * 60 * 60 * 24);
                        if (daysDiff > 30) {
                            localStorage.removeItem(key);
                            cleanedCount++;
                        }
                    }
                });
                
                if (cleanedCount > 0) {
                    console.log(`Membersihkan ${cleanedCount} data absensi harian yang lama`);
                }
            } catch (error) {
                console.error('Error cleaning up old attendance data:', error);
            }
        }

        // Auto-load data absensi saat halaman dimuat
        window.addEventListener('load', function() {
            // Animasi logo sudah berjalan otomatis dengan CSS
            
            // Restore data dari backup jika diperlukan
            restoreDataFromBackup();
            
            // Muat data siswa dari localStorage
            loadSiswaData();
            
            // Muat data user dari localStorage
            loadUserData();
            
            // Load data sistem terbaru dari server saat startup
            setTimeout(() => {
                loadSystemDataFromServer().then(success => {
                    if (success) {
                        console.log('‚úÖ Data sistem terbaru dimuat dari server');
                    }
                });
            }, 1000);
            
            // Bersihkan data absensi harian yang lama
            cleanupOldAttendanceData();
            
            // Pulihkan state jika ada
            const savedState = restoreState();
            if (savedState) {
                console.log('State dipulihkan dari:', new Date(savedState.timestamp).toLocaleString('id-ID'));
            }
            
            // Log jumlah data absensi lokal
            const localData = getLocalAbsensiData();
            if (localData.length > 0) {
                console.log(`Ditemukan ${localData.length} data absensi lokal`);
            }
            
            // Mulai auto-sync
            startAutoSync();
            
            // Auto-sync data sistem setiap 10 menit
            setInterval(() => {
                loadSystemDataFromServer();
            }, 600000);
            
            // Backup data setiap 5 menit
            setInterval(backupDataToMultipleStorage, 300000);
            
            // Tampilkan status sync setiap 2 menit
            setInterval(showSyncStatus, 120000);
            
            // Update tanggal setiap menit
            setInterval(updateDashboardDate, 60000);
            
            // Bersihkan data lama setiap hari (24 jam)
            setInterval(cleanupOldAttendanceData, 24 * 60 * 60 * 1000);
            
            // Sinkronisasi data pending saat load
            setTimeout(() => {
                syncPendingData();
                showSyncStatus();
            }, 2000);
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'968c973ff21a4a07',t:'MTc1NDEyNzM4Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
